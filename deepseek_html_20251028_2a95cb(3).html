<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهندس الشورت بريد العلمي - النسخة المحسنة والمصححة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #d97706;
            --primary-dark: #b45309;
            --primary-light: #f59e0b;
            --secondary-color: #059669;
            --warning-color: #dc2626;
            --background: #fef3c7;
            --card-bg: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --touch-target: 44px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fde68a 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 50%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem;
            margin: 1rem auto 0;
            max-width: 1200px;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .header-icon {
            font-size: 3rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
            text-align: center;
        }

        .header-info {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
        }

        .info-items {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: var(--shadow);
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            background: #f9fafb;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            background: white;
            border-bottom: 4px solid var(--primary-color);
            color: var(--primary-dark);
        }

        .tab:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .content {
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            min-height: 600px;
            max-width: 1200px;
            margin: 0 auto 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .card-amber {
            background: #fef3c7;
            border-color: #fbbf24;
        }

        .card-blue {
            background: #dbeafe;
            border-color: #60a5fa;
        }

        .card-green {
            background: #dcfce7;
            border-color: #4ade80;
        }

        .card-red {
            background: #fee2e2;
            border-color: #f87171;
        }

        .card-purple {
            background: #f3e8ff;
            border-color: #a855f7;
        }

        .card-yellow {
            background: #fef9c3;
            border-color: #facc15;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .subsection-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--text-dark);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-hint {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: var(--touch-target);
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #dc2626 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #0d9488 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #0f766e 100%);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-full {
            width: 100%;
        }

        .option-card {
            padding: 1.5rem;
            text-align: right;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .option-card.selected {
            border-color: var(--primary-color);
            background: #fef3c7;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.2);
        }

        .option-card-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .option-card-desc {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .mode-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mode-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-btn:hover {
            border-color: var(--primary-color);
        }

        .mode-btn.active {
            border-color: var(--primary-color);
            background: #fef3c7;
            font-weight: bold;
        }

        .mode-description {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .auto-settings {
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .stat-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-dark);
            margin-top: 0.25rem;
        }

        .ingredient-card {
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            background: white;
        }

        .ingredient-card.additive {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .ingredient-name {
            font-weight: bold;
            font-size: 1.125rem;
        }

        .ingredient-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .ingredient-note {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .step-card {
            background: #dbeafe;
            padding: 1.25rem;
            border-radius: 8px;
            border: 2px solid #93c5fd;
            margin-bottom: 1rem;
        }

        .step-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-start;
        }

        .step-number {
            width: 2.5rem;
            height: 2.5rem;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-action {
            font-weight: bold;
            font-size: 1.125rem;
            color: #1e40af;
            margin-bottom: 0.75rem;
        }

        .step-detail {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #93c5fd;
            margin-bottom: 0.75rem;
        }

        .step-tip {
            background: #fef9c3;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #facc15;
            margin-bottom: 0.75rem;
        }

        .checkpoint-card {
            border: 2px solid #d1d5db;
            border-radius: var(--border-radius);
            background: white;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .checkpoint-card.completed {
            border-color: var(--secondary-color);
            background: #ecfdf5;
        }

        .checkpoint-content {
            padding: 1.5rem;
        }

        .checkpoint-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .checkpoint-toggle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: 4px solid #d1d5db;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .checkpoint-toggle:hover {
            border-color: var(--primary-color);
        }

        .checkpoint-toggle.completed {
            background: var(--secondary-color);
            border-color: #059669;
            color: white;
        }

        .checkpoint-timing {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .checkpoint-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
        }

        .checkpoint-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .checkpoint-target {
            background: #dcfce7;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #22c55e;
        }

        .checkpoint-test {
            background: #dbeafe;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #3b82f6;
        }

        .checkpoint-why {
            background: #f3e8ff;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #8b5cf6;
            margin-bottom: 1rem;
        }

        .checkpoint-fix {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
        }

        .recipe-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .recipe-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .recipe-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .recipe-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .recipe-actions {
            display: flex;
            gap: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--secondary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .warning-badge {
            display: inline-block;
            background: #fef3c7;
            color: var(--primary-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        /* أنماط جديدة محسنة */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-group:hover {
            border-color: var(--primary-color);
        }

        .checkbox-group input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.25rem;
        }

        .butter-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .badge-european { background: #dcfce7; color: #166534; }
        .badge-american { background: #dbeafe; color: #1e40af; }
        .badge-vegetable { background: #f3e8ff; color: #7e22ce; }
        .badge-mixed { background: #fef3c7; color: #d97706; }

        .metric-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            transition: width 0.5s ease;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
        }

        /* فئات الألوان المفقودة */
        .text-green-700 { color: #15803d; }
        .text-amber-700 { color: #b45309; }
        .text-purple-700 { color: #7e22ce; }
        .text-yellow-700 { color: #a16207; }
        .text-blue-800 { color: #1e40af; }
        .text-green-800 { color: #166534; }
        .text-red-800 { color: #991b1b; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }

        /* فئات الخلفية المفقودة */
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-amber-50 { background-color: #fffbeb; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-50 { background-color: #f9fafb; }

        /* فئات الخطوط المفقودة */
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        /* فئات الهامش والمسافات المفقودة */
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }

        /* فئات الحاوية المرنة المفقودة */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .flex-wrap { flex-wrap: wrap; }

        /* فئات العرض والارتفاع المفقودة */
        .w-full { width: 100%; }
        .h-full { height: 100%; }

        /* فئات الحواف المفقودة */
        .border-green-200 { border-color: #bbf7d0; }
        .border-blue-200 { border-color: #bfdbfe; }

        /* تحسينات لبطاقات الاقتراحات الذكية */
        .suggestion-card {
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* تحسينات لبطاقات مقارنة البروفايلات */
        .profile-match-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-match-card:hover {
            transform: translateX(-5px);
        }

        /* أنيميشن للتحذيرات الحرجة */
        @keyframes pulseWarning {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        .critical-warning {
            animation: pulseWarning 2s ease-in-out infinite;
        }

        /* تحسينات الوصول Accessibility */
        .btn:focus,
        .form-input:focus,
        .form-select:focus,
        .option-card:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .step-grid, .checkpoint-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .recipe-preview {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .preview-stats {
                width: 100%;
            }
            
            .recipe-actions {
                width: 100%;
                justify-content: space-between;
            }

            .butter-options-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 1.25rem;
            }
            
            .subsection-title {
                font-size: 1.1rem;
            }
            
            .recipe-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .recipe-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .preview-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .recipe-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media print {
            .tabs,
            .btn,
            button,
            .notification {
                display: none !important;
            }
            
            .content {
                box-shadow: none;
                border: none;
            }
            
            .card {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-icon">🍪</div>
            <div>
                <h1>مهندس الشورت بريد العلمي - النسخة المحسنة والمصححة</h1>
                <p class="header-subtitle">النجاح من المرة الأولى - نظام ذكي محسن يعمل على جميع الأجهزة</p>
            </div>
        </div>
        <div class="header-info">
            <div class="info-items">
                <span>✅ حسابات دقيقة مبنية على 5 أبحاث علمية</span>
                <span>•</span>
                <span>🧠 توصيات ذكية تلقائية محسنة</span>
                <span>•</span>
                <span>🔬 شرح علمي دقيق لكل خطوة</span>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="start">🏁 البداية</button>
        <button class="tab" data-tab="setup">⚙️ الإعدادات</button>
        <button class="tab" data-tab="recipe" id="recipe-tab" disabled>📋 الوصفة</button>
        <button class="tab" data-tab="analyzer">🔍 محلل الوصفات</button>
        <button class="tab" data-tab="library">📚 مكتبتي</button>
        <button class="tab" data-tab="checkpoints">✅ نقاط الفحص</button>
        <button class="tab" data-tab="troubleshoot">🔧 استكشاف الأخطاء</button>
    </div>

    <div class="content">
        <!-- Start Screen -->
        <div id="start-screen" class="tab-content">
            <div class="text-center space-y-6">
                <div style="font-size: 4rem; margin-bottom: 1rem;">🍪</div>
                <h2 class="section-title">مرحباً بك في المختبر العلمي للشورت بريد المحسن</h2>
                
                <!-- نظام الأوضاع -->
                <div class="card card-blue">
                    <h3 class="subsection-title">🎯 اختر وضع الاستخدام</h3>
                    <div class="mode-selector">
                        <div class="mode-btn active" data-mode="beginner" onclick="setMode('beginner')">
                            <div>🎓 المبتدئ</div>
                            <div class="mode-description">توصيات تلقائية - نجاح مضمون</div>
                        </div>
                        <div class="mode-btn" data-mode="expert" onclick="setMode('expert')">
                            <div>🔬 الخبير</div>
                            <div class="mode-description">تحكم كامل + أدوات متقدمة</div>
                        </div>
                    </div>
                    <div id="mode-explanation" class="mt-4">
                        <div class="card">
                            <h4>🎓 وضع المبتدئ:</h4>
                            <ul class="space-y-2 mt-2">
                                <li>✅ إعدادات مثالية تلقائياً</li>
                                <li>✅ تحذيرات ذكية تمنع الأخطاء</li>
                                <li>✅ خطوات مبسطة ومؤتمتة</li>
                                <li>✅ شرح تفصيلي لكل خطوة</li>
                            </ul>
                        </div>
                        <div class="card mt-4 hidden" id="expert-explanation">
                            <h4>🔬 وضع الخبير:</h4>
                            <ul class="space-y-2 mt-2">
                                <li>🔧 تحكم كامل في جميع المتغيرات</li>
                                <li>🔧 تعديل طرق الخلط يدوياً</li>
                                <li>🔧 أدوات تحليل علمية متقدمة</li>
                                <li>🔧 تجاوز التوصيات التلقائية</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- البروفايلات السريعة -->
                <div class="card card-amber">
                    <h3 class="subsection-title">🚀 ابدأ بسرعة</h3>
                    <div class="grid-3">
                        <div class="option-card" onclick="selectQuickProfile('tender')">
                            <div class="option-card-title">🍰 طري يذوب في الفم</div>
                            <div class="option-card-desc">مثل تيد لاسو - ناعم وسلس</div>
                        </div>
                        <div class="option-card selected" onclick="selectQuickProfile('traditional')">
                            <div class="option-card-title">⚖️ متوازن تقليدي</div>
                            <div class="option-card-desc">التوازن الكلاسيكي المثالي</div>
                        </div>
                        <div class="option-card" onclick="selectQuickProfile('crispy')">
                            <div class="option-card-title">🍪 مقرمش متقشر</div>
                            <div class="option-card-desc">مثل البسكويت الاسكتلندي</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="switchTab('setup')">
                    🚀 ابدأ الآن - اختر الإعدادات
                </button>
            </div>
        </div>

        <!-- Setup Screen -->
        <div id="setup-screen" class="tab-content hidden">
            <div class="space-y-6">
                <h2 class="section-title">⚙️ الإعدادات الذكية المحسنة</h2>

                <!-- نظام التوصيات الذكية -->
                <div id="smart-recommendations-container">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>

                <!-- نظام الأوضاع -->
                <div class="card card-purple">
                    <h3 class="subsection-title">🎛️ وضع التشغيل الحالي: <span id="current-mode-display">المبتدئ</span></h3>
                    <div class="mode-selector">
                        <div class="mode-btn active" data-mode="beginner" onclick="setMode('beginner')">
                            <div>🎓 المبتدئ</div>
                            <div class="mode-description">تلقائي ومبسط</div>
                        </div>
                        <div class="mode-btn" data-mode="expert" onclick="setMode('expert')">
                            <div>🔬 الخبير</div>
                            <div class="mode-description">تحكم كامل</div>
                        </div>
                    </div>
                </div>

                <!-- Pan Dimensions -->
                <div class="card">
                    <h3 class="subsection-title">📏 أبعاد الصينية</h3>
                    <div class="grid-3">
                        <div>
                            <label class="form-label">الشكل</label>
                            <select class="form-select" id="pan-shape">
                                <option value="rectangular">مستطيل</option>
                                <option value="circular">دائري</option>
                            </select>
                        </div>
                        
                        <div id="rectangular-dimensions">
                            <div>
                                <label class="form-label">الطول (سم)</label>
                                <input type="number" class="form-input" id="pan-length" value="30" min="10" max="50">
                            </div>
                            <div>
                                <label class="form-label">العرض (سم)</label>
                                <input type="number" class="form-input" id="pan-width" value="20" min="10" max="50">
                            </div>
                        </div>
                        
                        <div id="circular-dimensions" class="hidden">
                            <div>
                                <label class="form-label">القطر (سم)</label>
                                <input type="number" class="form-input" id="pan-diameter" value="24" min="10" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="form-label">الارتفاع (سم)</label>
                        <input type="number" step="0.1" class="form-input" id="pan-height" value="1.5" min="0.5" max="3.0">
                        <div class="form-hint">💡 النطاق المثالي: 1.0-2.0 سم</div>
                    </div>
                </div>

                <!-- Texture Type -->
                <div class="card card-amber">
                    <h3 class="subsection-title">🎯 نوع القوام المطلوب</h3>
                    
                    <div class="space-y-3">
                        <div class="option-card" id="texture-tender" onclick="selectTexture('tender')">
                            <div class="option-card-title">🍰 طري يذوب في الفم</div>
                            <div class="option-card-desc">ناعم، هش، يذوب في الفم مثل بسكويت تيد لاسو</div>
                        </div>
                        <div class="option-card selected" id="texture-traditional" onclick="selectTexture('traditional')">
                            <div class="option-card-title">⚖️ متوازن تقليدي</div>
                            <div class="option-card-desc">التوازن الكلاسيكي بين الطراوة والقرمشة</div>
                        </div>
                        <div class="option-card" id="texture-crispy" onclick="selectTexture('crispy')">
                            <div class="option-card-title">🍪 مقرمش متقشر</div>
                            <div class="option-card-desc">مقرمش، متقشر، جاف مثل البسكويت الاسكتلندي التقليدي</div>
                        </div>
                    </div>
                </div>

                <!-- Butter Type - محسن مع أنواع جديدة -->
                <div class="card card-blue">
                    <h3 class="subsection-title">🧈 نوع الزبدة المتاحة</h3>
                    <div class="grid-4 butter-options-grid" id="butter-options">
                        <div class="option-card selected" id="butter-european" onclick="selectButter('european')">
                            <div class="option-card-title">أوروبية (82-86% دهون)</div>
                            <div class="text-green-700 text-sm mt-1">⭐ موصى بها علمياً للجميع</div>
                            <span class="butter-badge badge-european">أفضل</span>
                        </div>
                        <div class="option-card" id="butter-american" onclick="selectButter('american')">
                            <div class="option-card-title">عادية (80% دهون)</div>
                            <div class="text-amber-700 text-sm mt-1">⚠️ قد تحتاج تعديلات للقوام المقرمش</div>
                            <span class="butter-badge badge-american">جيدة</span>
                        </div>
                        <div class="option-card" id="butter-vegetable" onclick="selectButter('vegetable')">
                            <div class="option-card-title">نباتية</div>
                            <div class="text-purple-700 text-sm mt-1">🌱 قليلة الماء - مناسبة للنباتيين</div>
                            <span class="butter-badge badge-vegetable">نباتي</span>
                        </div>
                        <div class="option-card" id="butter-mixed" onclick="selectButter('mixed')">
                            <div class="option-card-title">خليط</div>
                            <div class="text-yellow-700 text-sm mt-1">🔀 مزيج من الزبدة والمارجرين</div>
                            <span class="butter-badge badge-mixed">خليط</span>
                        </div>
                    </div>
                </div>

                <!-- نظام الخلط (يظهر فقط في وضع الخبير) -->
                <div id="mixing-method-section" class="card card-blue hidden">
                    <h3 class="subsection-title">🌀 نظام الخلط المتقدم</h3>
                    <p class="mb-4 text-blue-800">في وضع الخبير، يمكنك تعديل طريقة الخلط يدوياً</p>
                    
                    <div class="grid-2">
                        <div class="option-card" data-method="sablage" onclick="handleMixingMethodSelect('sablage', this)">
                            <div class="option-card-title">👐 طريقة الفرك (Sablage)</div>
                            <div class="option-card-desc">زبدة باردة تخلط بالفرك للحصول على قوام مقرمش متقشر</div>
                        </div>
                        <div class="option-card" data-method="creaming" onclick="handleMixingMethodSelect('creaming', this)">
                            <div class="option-card-title">🌀 طريقة الخفق (Creaming)</div>
                            <div class="option-card-desc">زبدة طرية تخفق مع السكر للحصول على قوام طري يذوب في الفم</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 auto-settings">
                        <div class="font-semibold">🎯 التوصية التلقائية:</div>
                        <div class="text-sm text-gray-600" id="recommended-mixing-method">طريقة الفرك (Sablage)</div>
                    </div>
                </div>

                <!-- الإعدادات التلقائية -->
                <div class="card card-purple">
                    <h3 class="subsection-title">🤖 الإعدادات المثلى تلقائياً</h3>
                    <div id="auto-settings-display">
                        <!-- سيتم تعبئته بالجافاسكريبت -->
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="card card-green">
                    <h3 class="subsection-title">➕ خيارات إضافية</h3>
                    
                    <div class="checkbox-group" id="rice-flour-checkbox">
                        <input type="checkbox" class="checkbox" id="use-rice-flour">
                        <div>
                            <div class="font-semibold">إضافة دقيق أرز (25%)</div>
                            <div class="text-sm text-gray-600 mt-1">
                                🔬 يزيد القرمشة بنسبة 30% - موصى به للقوام المقرمش فقط
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-group mt-4" id="cornstarch-checkbox">
                        <input type="checkbox" class="checkbox" id="use-cornstarch">
                        <div>
                            <div class="font-semibold">إضافة نشا الذرة (15%)</div>
                            <div class="text-sm text-gray-600 mt-1">
                                🔬 يحسن الطراوة - موصى به للقوام الطري فقط
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success btn-full" id="calculate-recipe-btn">
                    🧮 احسب الوصفة الدقيقة مع التوصيات المحسنة
                </button>
            </div>
        </div>

        <!-- Recipe Screen -->
        <div id="recipe-screen" class="tab-content hidden">
            <div class="space-y-6">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="section-title">📋 وصفتك الكاملة المحسنة</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-danger" onclick="switchTab('checkpoints')">
                            ⚠️ نقاط الفحص الحرجة
                        </button>
                        <button class="btn btn-primary" onclick="switchTab('setup')">
                            ⚙️ تعديل الإعدادات
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid-4">
                    <div class="stat-card">
                        <div class="stat-icon">⚖️</div>
                        <div class="stat-label">الوزن</div>
                        <div class="stat-value" id="stat-weight">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-label">نسبة الدهون</div>
                        <div class="stat-value" id="stat-fat">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🌡️</div>
                        <div class="stat-label">Aw المتوقع</div>
                        <div class="stat-value" id="stat-aw">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏰</div>
                        <div class="stat-label">الصلاحية</div>
                        <div class="stat-value" id="stat-shelf">-</div>
                    </div>
                </div>

                <!-- Save Recipe Button -->
                <div class="card card-green" id="save-recipe-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h4 style="margin: 0;">💾 حفظ هذه الوصفة</h4>
                            <p style="margin: 0.5rem 0 0 0; color: #666;">احفظ الوصفة لتقييمها ومقارنتها لاحقاً</p>
                        </div>
                        <button class="btn btn-success" id="save-recipe-btn">
                            💾 حفظ الوصفة
                        </button>
                    </div>
                </div>

                <!-- Ingredients -->
                <div class="card card-amber">
                    <h3 class="subsection-title">🧪 المقادير الدقيقة</h3>
                    <div class="grid-2" id="ingredients-list">
                        <!-- سيتم تعبئته بالجافاسكريبت -->
                    </div>
                </div>

                <!-- Instructions Sections -->
                <div class="space-y-4" id="instructions-container">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>
            </div>
        </div>

        <!-- Recipe Analyzer Screen -->
        <div id="analyzer-screen" class="tab-content hidden">
            <div class="space-y-6">
                <h2 class="section-title">🔍 محلل الوصفات العلمي المتقدم</h2>
                
                <div class="card card-blue">
                    <h3 class="subsection-title">🧮 أدخل مقادير الوصفة يدوياً</h3>
                    <p class="mb-4">املأ الحقول التالية بالمقادير المستخدمة في وصفة الشورت بريد المراد تحليلها</p>
                    
                    <div class="grid-2">
                        <!-- المكونات الأساسية -->
                        <div class="space-y-4">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-flour" onchange="toggleInput('flour')">
                                    <div>
                                        <label class="form-label">الدقيق (غرام)</label>
                                        <input type="number" class="form-input" id="flour" placeholder="كمية الدقيق" disabled>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-butter" onchange="toggleInput('butter')">
                                    <div>
                                        <label class="form-label">الزبدة (غرام)</label>
                                        <input type="number" class="form-input" id="butter" placeholder="كمية الزبدة" disabled>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-sugar" onchange="toggleInput('sugar')">
                                    <div>
                                        <label class="form-label">السكر (غرام)</label>
                                        <input type="number" class="form-input" id="sugar" placeholder="كمية السكر" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- المكونات الإضافية -->
                        <div class="space-y-4">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-rice-flour" onchange="toggleInput('rice-flour')">
                                    <div>
                                        <label class="form-label">دقيق الأرز (غرام)</label>
                                        <input type="number" class="form-input" id="rice-flour" placeholder="كمية دقيق الأرز" disabled>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-cornstarch" onchange="toggleInput('cornstarch')">
                                    <div>
                                        <label class="form-label">نشا الذرة (غرام)</label>
                                        <input type="number" class="form-input" id="cornstarch" placeholder="كمية نشا الذرة" disabled>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="has-salt" onchange="toggleInput('salt')">
                                    <div>
                                        <label class="form-label">الملح (غرام)</label>
                                        <input type="number" class="form-input" id="salt" placeholder="كمية الملح" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- طريقة الخلط -->
                <div class="card card-purple">
                    <h3 class="subsection-title">🌀 طريقة الخلط المستخدمة</h3>
                    <div class="grid-3">
                        <div class="option-card" onclick="selectAnalyzerMixingMethod('sablage', this)">
                            <div class="option-card-title">👐 طريقة الفرك (Sablage)</div>
                            <div class="option-card-desc">زبدة باردة تخلط بالفرك</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerMixingMethod('creaming', this)">
                            <div class="option-card-title">🌀 طريقة الخفق (Creaming)</div>
                            <div class="option-card-desc">زبدة طرية تخفق مع السكر</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerMixingMethod('unknown', this)">
                            <div class="option-card-title">❓ غير معروف</div>
                            <div class="option-card-desc">لم يتم تحديد الطريقة</div>
                        </div>
                    </div>
                </div>

                <!-- إعدادات الخبز -->
                <div class="card card-amber">
                    <h3 class="subsection-title">🔥 إعدادات الخبز</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">درجة حرارة الخبز (°م)</label>
                            <input type="number" class="form-input" id="baking-temp" placeholder="مثال: 160">
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدة الخبز (دقيقة)</label>
                            <input type="number" class="form-input" id="baking-time" placeholder="مثال: 25">
                        </div>
                    </div>
                </div>

                <!-- نوع الزبدة -->
                <div class="card card-green">
                    <h3 class="subsection-title">🧈 نوع الزبدة المستخدم</h3>
                    <div class="grid-4">
                        <div class="option-card" onclick="selectAnalyzerButterType('european', this)">
                            <div class="option-card-title">أوروبية (82-86%)</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerButterType('american', this)">
                            <div class="option-card-title">أمريكية (80%)</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerButterType('vegetable', this)">
                            <div class="option-card-title">نباتية</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerButterType('unknown', this)">
                            <div class="option-card-title">❓ غير معروف</div>
                        </div>
                    </div>
                </div>

                <!-- نوع السكر -->
                <div class="card card-blue">
                    <h3 class="subsection-title">🍬 نوع السكر المستخدم</h3>
                    <div class="grid-3">
                        <div class="option-card" onclick="selectAnalyzerSugarType('granulated', this)">
                            <div class="option-card-title">سكر محبب</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerSugarType('powdered', this)">
                            <div class="option-card-title">سكر بودرة</div>
                        </div>
                        <div class="option-card" onclick="selectAnalyzerSugarType('unknown', this)">
                            <div class="option-card-title">❓ غير معروف</div>
                        </div>
                    </div>
                </div>

                <!-- خيارات إضافية -->
                <div class="card card-red">
                    <h3 class="subsection-title">⚡ تقنيات إضافية مستخدمة</h3>
                    <div class="grid-2">
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-chilling">
                            <div>
                                <div class="font-semibold">التبريد قبل الخبز</div>
                                <div class="text-sm text-gray-600 mt-1">تبريد العجين قبل الخبز لمدة ساعة على الأقل</div>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-docking">
                            <div>
                                <div class="font-semibold">التخريم (Docking)</div>
                                <div class="text-sm text-gray-600 mt-1">تخريم سطح العجين بالشوكة قبل الخبز</div>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-twice-baked">
                            <div>
                                <div class="font-semibold">الخبز المزدوج</div>
                                <div class="text-sm text-gray-600 mt-1">تقنية الخبز مرتين للحصول على قرمشة استثنائية</div>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-vanilla">
                            <div>
                                <div class="font-semibold">إضافة الفانيليا</div>
                                <div class="text-sm text-gray-600 mt-1">إضافة خلاصة الفانيليا للنكهة</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" onclick="analyzeManualRecipe()">
                    🔍 حلل الوصفة علمياً
                </button>

                <!-- نتائج التحليل -->
                <div id="manual-analysis-results" class="hidden">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>

                <!-- وصفات نموذجية للاختبار -->
                <div class="card card-green">
                    <h3 class="subsection-title">🧪 وصفات نموذجية للاختبار</h3>
                    <div class="grid-3">
                        <div class="option-card" onclick="loadSampleRecipe('ted-lasso')">
                            <div class="option-card-title">🍪 بسكويت تيد لاسو</div>
                            <div class="option-card-desc">وصفة طرية تذوب في الفم</div>
                        </div>
                        <div class="option-card" onclick="loadSampleRecipe('traditional')">
                            <div class="option-card-title">⚖️ تقليدي متوازن</div>
                            <div class="option-card-desc">وصفة كلاسيكية متوازنة</div>
                        </div>
                        <div class="option-card" onclick="loadSampleRecipe('crispy')">
                            <div class="option-card-title">🔥 مقرمش متقشر</div>
                            <div class="option-card-desc">وصفة مقرمشة مع دقيق الأرز</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Screen -->
        <div id="library-screen" class="tab-content hidden">
            <div class="space-y-6">
                <div class="library-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="section-title">📚 مكتبة وصفاتك</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div class="stat-card">
                            <div class="stat-value" id="library-count">0</div>
                            <div class="stat-label">وصفة محفوظة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="success-rate">0%</div>
                            <div class="stat-label">معدل النجاح</div>
                        </div>
                        <button class="btn" id="export-all-btn" style="background: var(--secondary-color); color: white;">
                            📤 تصدير الكل
                        </button>
                    </div>
                </div>

                <div id="recipe-grid" class="recipe-grid">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>

                <div id="empty-library" class="text-center hidden">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">📚</div>
                    <h3>لا توجد وصفات محفوظة بعد</h3>
                    <p>احفظ وصفاتك الأولى لتظهر هنا</p>
                    <button class="btn btn-primary mt-4" onclick="switchTab('setup')">
                        🚀 إنشاء وصفة جديدة
                    </button>
                </div>
            </div>
        </div>

        <!-- Checkpoints Screen -->
        <div id="checkpoints-screen" class="tab-content hidden">
            <div class="space-y-6">
                <div class="card card-red">
                    <h2 class="section-title">✅ نقاط الفحص الحرجة المحسنة - طريقك للنجاح المضمون</h2>
                    <p class="text-red-800">
                        هذه النقاط الـ8 هي الفرق بين النجاح والفشل. افحص كل واحدة في وقتها المحدد.
                    </p>
                    <div class="mt-4 bg-white p-4 rounded-lg">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;" id="completed-count">0/8</div>
                            <div>
                                <div class="font-bold">نقاط مكتملة</div>
                                <div class="text-sm text-gray-600">استمر - أنت على الطريق الصحيح!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4" id="checkpoints-list">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>
            </div>
        </div>

        <!-- Troubleshoot Screen -->
        <div id="troubleshoot-screen" class="tab-content hidden">
            <div class="space-y-6">
                <div class="card card-red">
                    <h2 class="section-title">🔧 استكشاف الأخطاء المحسن - دليل الإنقاذ الفوري</h2>
                    <p class="text-red-800">
                        حدث خطأ ما؟ لا تقلق. هذا الدليل المحسن سيساعدك على فهم المشكلة وحلها - سواء قبل الخبز، أثناءه، أو بعده.
                    </p>
                </div>

                <div class="space-y-4" id="troubleshoot-list">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>

                <!-- Prevention Guide -->
                <div class="card card-green">
                    <h3 class="subsection-title">🛡️ القاعدة الذهبية للوقاية المحسنة</h3>
                    <div class="grid-3">
                        <div class="card">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 2.5rem; height: 2.5rem; background: var(--secondary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.125rem; flex-shrink: 0;">1</div>
                                <div style="font-size: 2rem;">🌡️</div>
                            </div>
                            <h4 class="font-bold text-green-900 mb-2">درجة الحرارة المناسبة</h4>
                            <p class="text-green-800 text-sm">اختر درجة حرارة الزبدة المناسبة لطريقة الخلط المختارة ونوع الزبدة</p>
                        </div>
                        <div class="card">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 2.5rem; height: 2.5rem; background: var(--secondary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.125rem; flex-shrink: 0;">2</div>
                                <div style="font-size: 2rem;">⏱️</div>
                            </div>
                            <h4 class="font-bold text-green-900 mb-2">الوقت المناسب</h4>
                            <p class="text-green-800 text-sm">التزم بالوقت المحدد لكل طريقة خلط ولا تبالغ مع مراعاة نوع الزبدة</p>
                        </div>
                        <div class="card">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 2.5rem; height: 2.5rem; background: var(--secondary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.125rem; flex-shrink: 0;">3</div>
                                <div style="font-size: 2rem;">✅</div>
                            </div>
                            <h4 class="font-bold text-green-900 mb-2">افحص باستمرار</h4>
                            <p class="text-green-800 text-sm">عند كل نقطة فحص - توقف واختبر. الوقاية أفضل من العلاج.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // النظام الأساسي المحسن - State Management
        // =============================================

        class AppState {
            constructor() {
                this.state = {
                    // وضع المستخدم
                    mode: 'beginner', // 'beginner' or 'expert'
                    
                    // الإعدادات الأساسية
                    panShape: 'rectangular',
                    dimensions: { length: 30, width: 20, diameter: 24 },
                    height: 1.5,
                    textureType: 'traditional',
                    butterType: 'european',
                    mixingMethod: 'sablage',
                    
                    // الإعدادات المتقدمة (للوضع الخبير)
                    useRiceFlour: false,
                    useCornstarch: false,
                    
                    // النتائج
                    currentRecipe: null,
                    completedCheckpoints: []
                };
                
                this.subscribers = new Set();
            }
            
            get(key) {
                return key.split('.').reduce((obj, i) => obj?.[i], this.state);
            }
            
            set(key, value) {
                const keys = key.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((obj, i) => obj[i], this.state);
                target[lastKey] = value;
                this.notify(key, value);
            }
            
            subscribe(callback) {
                this.subscribers.add(callback);
            }
            
            notify(key, value) {
                this.subscribers.forEach(callback => callback(key, value));
            }
            
            // تحديث شامل للحالة
            update(newState) {
                this.state = { ...this.state, ...newState };
                this.notify('all', this.state);
            }
        }

        // =============================================
        // المحركات العلمية المحسنة
        // =============================================

        class ScientificData {
            static get PROFILES() {
                return {
                    'tender': {
                        name: 'طري يذوب في الفم',
                        description: 'ناعم، هش، يذوب في الفم مثل بسكويت تيد لاسو',
                        mixingMethod: 'creaming',
                        sugarType: 'powdered',
                        additive: { type: 'cornstarch', ratio: 0.12 },
                        recommendedButter: 'european',
                        ratio: [1, 2, 3],
                        density: 0.58,
                        bakingTemp: 149,
                        bakingTime: '50-70 دقيقة',
                        butterTemp: '21-22°م',
                        expectedAw: '0.40-0.50',
                        shelfLife: '7-14 يوم',
                        specialInstructions: [
                            'استخدم السكر البودرة لتحقيق النعومة القصوى',
                            'نشا الذرة يحسن الملمس الرملي',
                            'الخفق المعتدل لمدة 3-4 دقائق',
                            'درجة الحرارة المنخفضة تحافظ على الطراوة'
                        ]
                    },
                    'traditional': {
                        name: 'متوازن تقليدي', 
                        description: 'التوازن الكلاسيكي بين الطراوة والقرمشة',
                        mixingMethod: 'sablage',
                        sugarType: 'granulated',
                        additive: { type: 'none', ratio: 0 },
                        recommendedButter: 'european',
                        ratio: [1, 2, 3],
                        density: 0.62,
                        bakingTemp: 160,
                        bakingTime: '25-35 دقيقة',
                        butterTemp: '4-7°م',
                        expectedAw: '0.35-0.45',
                        shelfLife: '14-21 يوم',
                        specialInstructions: [
                            'الفرك حتى يصبح الخليط مثل الرمل الناعم',
                            'قطع الزبدة يجب أن تكون بحجم حبات البازلاء',
                            'التبريد لمدة ساعتين على الأقل',
                            'الحرارة المتوسطة تحقق التوازن المطلوب'
                        ]
                    },
                    'crispy': {
                        name: 'مقرمش متقشر',
                        description: 'مقرمش، متقشر، جاف مثل البسكويت الاسكتلندي التقليدي',
                        mixingMethod: 'sablage',
                        sugarType: 'granulated',
                        additive: { type: 'riceFlour', ratio: 0.25 },
                        recommendedButter: 'european',
                        ratio: [1, 2, 3],
                        density: 0.62,
                        bakingTemp: 177,
                        bakingTime: '35 دقيقة (المرحلة الأولى)',
                        twiceBaked: {
                            enabled: true,
                            firstBakeTemp: 177,
                            firstBakeDuration: '35 دقيقة',
                            coolingDuration: '10 دقائق',
                            secondBakeMethod: 'residual heat',
                            secondBakeDuration: '30-45 دقيقة',
                            ovenState: 'off',
                            scientificBasis: 'إزالة الرطوبة التدريجية لتحقيق Aw < 0.35 دون تحميص إضافي'
                        },
                        butterTemp: '4-7°م',
                        expectedAw: '0.20-0.30',
                        shelfLife: '30-45 يوم',
                        specialInstructions: [
                            'دقيق الأرز (25%) يزيد القرمشة بنسبة 30%',
                            'الفرك حتى يصبح خشن مثل حبات الذرة',
                            'التبريد طوال الليل للحصول على أفضل قرمشة',
                            'الحرارة العالية تحقق القرمشة المطلوبة',
                            '⭐ تقنية الخبز المزدوج إلزامية للحصول على النتائج المثالية'
                        ]
                    }
                };
            }
            
            static get BUTTER_TYPES() {
                return {
                    'european': {
                        name: 'أوروبية',
                        fatContent: 0.82,
                        waterContent: 0.16,
                        description: '82-86% دهون - مثالية للقوام المثالي',
                        color: '#dcfce7',
                        textColor: '#166534'
                    },
                    'american': {
                        name: 'أمريكية', 
                        fatContent: 0.80,
                        waterContent: 0.18,
                        description: '80% دهون - جيدة مع تعديلات بسيطة',
                        color: '#dbeafe',
                        textColor: '#1e40af'
                    },
                    'vegetable': {
                        name: 'نباتية',
                        fatContent: 0.85, 
                        waterContent: 0.02,
                        description: 'قليلة الماء - مناسبة للنباتيين',
                        color: '#f3e8ff',
                        textColor: '#7e22ce'
                    },
                    'mixed': {
                        name: 'خليط',
                        fatContent: 0.78,
                        waterContent: 0.15,
                        description: 'مزيج من الزبدة والمارجرين',
                        color: '#fef3c7',
                        textColor: '#d97706'
                    }
                };
            }
            
            static get MIXING_METHODS() {
                return {
                    'sablage': {
                        name: 'طريقة الفرك',
                        description: 'زبدة باردة تخلط بالفرك للحصول على قوام مقرمش متقشر',
                        butterTemp: '4-7°م',
                        texture: 'مقرمش متقشر',
                        scientificBasis: 'قطع الزبدة الباردة تخلق طبقات متقشرة عند الخبز',
                        densityAdjustment: 1.02
                    },
                    'creaming': {
                        name: 'طريقة الخفق',
                        description: 'زبدة طرية تخفق مع السكر للحصول على قوام طري يذوب في الفم',
                        butterTemp: '21-22°م',
                        texture: 'طري يذوب في الفم',
                        scientificBasis: 'الهواء المحبوس أثناء الخفق يخلق قواماً أخف وأكثر طراوة',
                        densityAdjustment: 0.95
                    }
                };
            }
            
            static get ENHANCED_CHECKPOINTS() {
                return [
                    {
                        timing: 'قبل البدء',
                        check: 'جودة وكثافة الزبدة',
                        target: 'زبدة مبردة حسب النوع المختار',
                        test: 'افحص تاريخ الصلاحية والملمس',
                        whyItMatters: 'الزبدة الفاسدة أو المخزنة improperly تفسد العجين',
                        fix: 'استخدم زبدة طازجة ومخزنة بشكل صحيح'
                    },
                    {
                        timing: 'قبل البدء',
                        check: 'درجة حرارة الزبدة',
                        target: '{butterTemp}',
                        test: 'افحص حسب الطريقة المختارة',
                        whyItMatters: 'درجة الحرارة الخاطئة تعطي قواماً غير مرغوب',
                        fix: 'اضبط الحرارة حسب طريقة الخلط'
                    },
                    {
                        timing: 'أثناء الخلط',
                        check: 'توزيع الدهون في العجين',
                        target: 'توزيع متجانس بدون تكوين غلوتين',
                        test: 'افحص ملمس العجين - يجب أن يكون رملياً',
                        whyItMatters: 'التوزيع غير المتجانس يؤدي إلى قوام غير متسق',
                        fix: 'اخلط لمدة أطول أو أقل حسب الحاجة'
                    },
                    {
                        timing: 'بعد الخلط',
                        check: 'قوام العجين',
                        target: 'متماسك ولكن غير لزج',
                        test: 'اضغط كرة صغيرة - يجب أن تتماسك بدون لزوجة',
                        whyItMatters: 'العجين اللزج يعني زبدة دافئة جداً',
                        fix: 'برد العجين 15 دقيقة إضافية'
                    },
                    {
                        timing: 'بعد التشكيل',
                        check: 'سمك العجين',
                        target: '1.0-2.0 سم',
                        test: 'استخدم مسطرة للتحقق من السمك',
                        whyItMatters: 'السمك غير المنتظم يؤدي إلى خبز غير متساو',
                        fix: 'عدل السمك قبل الخبز'
                    },
                    {
                        timing: 'قبل الخبز',
                        check: 'ثقب السطح',
                        target: 'ثقوب متساوية ومنتظمة',
                        test: 'تأكد من تغطية السطح كاملاً بالثقوب',
                        whyItMatters: 'يمنع انتفاخ العجين أثناء الخبز',
                        fix: 'أعد ثقب المناطق غير المثقوبة'
                    },
                    {
                        timing: 'أثناء الخبز (15 دقيقة)',
                        check: 'لون الحواف',
                        target: 'ذهبي فاتح جداً',
                        test: 'افحص حواف الصينية',
                        whyItMatters: 'يدل على نضج متساوي',
                        fix: 'دور الصينية إذا لزم الأمر'
                    },
                    {
                        timing: 'بعد الخبز',
                        check: 'التبريد الكافي',
                        target: 'يبرد تماماً قبل التقطيع',
                        test: 'المس المركز - يجب أن يكون بارداً',
                        whyItMatters: 'التقطيع الساخن يؤدي إلى تكسر',
                        fix: 'انتظر حتى يبرد تماماً'
                    }
                ];
            }
        }

        class RecipeEngine {
            constructor() {
                this.data = ScientificData;
            }
            
            calculateRecipe(state) {
                const profile = this.data.PROFILES[state.textureType];
                const effectiveState = this.applyRecommendations(state, profile);
                
                // الحسابات الأساسية
                const area = this.calculateArea(effectiveState.panShape, effectiveState.dimensions);
                const volume = area * effectiveState.height;
                const dynamicDensity = this.calculateDynamicDensity(effectiveState);
                const weight = volume * dynamicDensity;
                
                // استخدام النسب من البروفايل
                const ratio = profile.ratio;
                const total = ratio.reduce((sum, val) => sum + val, 0);
                const unit = weight / total;
                
                let flour = Math.round(unit * ratio[2]);
                const butter = Math.round(unit * ratio[1]);
                const sugar = Math.round(unit * ratio[0]);
                
                // إدارة المضافات
                const additives = {};
                if (profile.additive.type !== 'none') {
                    const additiveAmount = Math.round(flour * profile.additive.ratio);
                    additives[this.getAdditiveName(profile.additive.type)] = additiveAmount;
                    flour -= additiveAmount;
                }
                
                const salt = Math.round(flour * 0.01 * 10) / 10;
                
                // حساب Aw الفعلي المحسن
                const awAnalysis = this.calculateWaterActivity(
                    { flour, butter, sugar }, 
                    effectiveState.butterType, 
                    profile.bakingTemp,
                    profile.twiceBaked?.enabled || false
                );
                
                const recipe = {
                    ingredients: { flour, butter, sugar, salt, additives },
                    profile: profile,
                    analysis: {
                        area: Math.round(area),
                        volume: Math.round(volume),
                        weight: Math.round(weight),
                        finalHeight: this.calculateFinalHeight(effectiveState),
                        density: dynamicDensity,
                        fatPercent: ((butter / weight) * 100).toFixed(1),
                        expectedAw: awAnalysis.value,
                        category: awAnalysis.category,
                        shelfLife: awAnalysis.shelfLife,
                        recommendedButterTemp: profile.butterTemp,
                        optimalBaking: `${profile.bakingTemp}°م لمدة ${profile.bakingTime}`
                    },
                    instructions: this.generateInstructions(profile, effectiveState),
                    recommendations: this.generateRecommendations(effectiveState, profile),
                    scientificReport: this.generateScientificReport({ flour, butter, sugar }, effectiveState, profile)
                };
                
                return recipe;
            }
            
            applyRecommendations(state, profile) {
                if (state.mode === 'beginner') {
                    // في وضع المبتدئ، نطبق التوصيات تلقائياً
                    return {
                        ...state,
                        mixingMethod: profile.mixingMethod,
                        useRiceFlour: profile.additive.type === 'riceFlour',
                        useCornstarch: profile.additive.type === 'cornstarch',
                        butterType: profile.recommendedButter || 'european'
                    };
                } else {
                    // في وضع الخبير، نحترم اختيارات المستخدم مع بعض التوصيات
                    return {
                        ...state,
                        mixingMethod: state.mixingMethod || profile.mixingMethod
                    };
                }
            }
            
            // ✅ تصحيح حساب Aw
            calculateWaterActivity(ingredients, butterType, bakingTemp, useTwiceBaked, textureType) {
                const baseValues = {
                    'tender': { 
                        baseAw: 0.48,      // ✅ كان 0.48 صحيح
                        sugarBinding: 0.40,
                        starchBinding: 0.45 
                    },
                    'traditional': { 
                        baseAw: 0.38,      // ✅ كان 0.38 صحيح
                        sugarBinding: 0.33,
                        starchBinding: 0.35 
                    },
                    'crispy': { 
                        baseAw: 0.28,      // ✅ كان 0.28 صحيح - لكن يجب استخدامه!
                        sugarBinding: 0.25,
                        starchBinding: 0.25 
                    }
                };
                
                const base = baseValues[textureType] || baseValues['traditional'];
                let awValue = base.baseAw;
                
                // ⚠️ المشكلة: التعديلات تطغى على القيم الأساسية
                // الحل: تقليل تأثير التعديلات
                
                // تأثير طريقة الخلط (مخفض)
                if (this.state && this.state.mixingMethod === 'creaming') {
                    awValue += 0.02;  // ✅ كان 0.04 - مبالغ فيه
                } else if (this.state && this.state.mixingMethod === 'sablage') {
                    awValue -= 0.02;  // ✅ كان 0.03
                }
                
                // تأثير المضافات
                if (this.state && this.state.useCornstarch) {
                    awValue += 0.02;  // ✅ كان 0.03
                } else if (this.state && this.state.useRiceFlour) {
                    awValue -= 0.03;  // ✅ كان 0.05
                }
                
                // تأثير درجة الحرارة
                if (bakingTemp >= 170) {
                    awValue -= 0.05;  // ✅ كان 0.08 - مبالغ
                } else if (bakingTemp <= 150) {
                    awValue += 0.03;  // ✅ كان 0.05
                }
                
                // ⭐ تأثير الخبز المزدوج - حاسم للقوام المقرمش
                if (useTwiceBaked) {
                    if (textureType === 'crispy') {
                        awValue -= 0.10;  // ✅ كان 0.12 - معقول لكن دعنا نحافظ على 0.10
                    } else {
                        awValue -= 0.04;  // ✅ كان 0.06
                    }
                }
                
                // ✅ حدود واقعية محسّنة
                if (textureType === 'tender') {
                    awValue = Math.min(0.52, Math.max(0.42, awValue));  // 0.42-0.52
                } else if (textureType === 'crispy') {
                    awValue = Math.min(0.35, Math.max(0.22, awValue));  // 0.22-0.35 ⭐
                } else {
                    awValue = Math.min(0.43, Math.max(0.35, awValue));  // 0.35-0.43
                }
                
                // ✅ تصنيف محسّن
                let category, shelfLife;
                if (awValue < 0.28) {
                    category = 'جاف جداً';
                    shelfLife = '45-60 يوم';
                } else if (awValue < 0.35) {
                    category = 'مقرمش وجاف';  // ⭐ هذا للمقرمش
                    shelfLife = '30-45 يوم';
                } else if (awValue < 0.40) {
                    category = 'مقرمش';
                    shelfLife = '21-30 يوم';
                } else if (awValue < 0.45) {
                    category = 'متوازن';
                    shelfLife = '14-21 يوم';
                } else {
                    category = 'طري';  // ⭐ هذا للطري
                    shelfLife = '7-14 يوم';
                }
                
                return {
                    value: awValue.toFixed(3),
                    category: category,
                    shelfLife: shelfLife,
                    confidence: 0.92
                };
            }
            
            calculateDynamicDensity(state) {
                const profile = this.data.PROFILES[state.textureType];
                let density = profile.density;
                
                // Apply mixing method adjustment
                if (state.mixingMethod) {
                    const method = this.data.MIXING_METHODS[state.mixingMethod];
                    density *= method.densityAdjustment;
                }
                
                // Then apply butter type corrections
                const butterInfo = this.data.BUTTER_TYPES[state.butterType];
                if (butterInfo) {
                    density += (butterInfo.fatContent - 0.80) * 0.1;
                }
                
                // Additives reduce density
                if (state.useRiceFlour) density -= 0.015;
                if (state.useCornstarch) density -= 0.020;
                
                // Clamp to realistic range
                return Math.max(0.50, Math.min(0.72, density));
            }
            
            calculateFinalHeight(state) {
                let heightMultiplier = 1.0;
                
                // تأثير طريقة الخلط
                const methodMultipliers = {
                    'sablage': 0.92,
                    'creaming': 1.15
                };
                
                heightMultiplier *= methodMultipliers[state.mixingMethod] || 1.0;
                
                // تأثير الإضافات
                if (state.useRiceFlour) heightMultiplier *= 0.96;
                if (state.useCornstarch) heightMultiplier *= 0.94;
                
                // تأثير نوع الزبدة
                if (state.butterType === 'european') heightMultiplier *= 1.02;
                if (state.butterType === 'vegetable') heightMultiplier *= 0.98;
                
                const finalHeight = state.height * heightMultiplier;
                return Math.max(0.5, Math.min(2.5, finalHeight)).toFixed(1);
            }
            
            calculateArea(shape, dimensions) {
                if (shape === 'rectangular') {
                    return dimensions.length * dimensions.width;
                } else {
                    return Math.PI * Math.pow(dimensions.diameter / 2, 2);
                }
            }
            
            getAdditiveName(type) {
                const names = {
                    'cornstarch': 'نشا الذرة',
                    'riceFlour': 'دقيق الأرز',
                    'none': 'بدون إضافات'
                };
                return names[type];
            }
            
            generateInstructions(profile, state) {
                const method = this.data.MIXING_METHODS[state.mixingMethod || profile.mixingMethod];
                
                return {
                    mixing: {
                        title: `🌀 ${method.name}`,
                        steps: this.getMixingSteps(state.mixingMethod || profile.mixingMethod),
                        scientificBasis: method.scientificBasis,
                        specialInstructions: profile.specialInstructions
                    }
                };
            }
            
            getMixingSteps(method) {
                const steps = {
                    sablage: [
                        `❄️ تأكد من أن الزبدة ${this.data.MIXING_METHODS.sablage.butterTemp}`,
                        `👐 افرك الزبدة الباردة مع الدقيق والسكر بأطراف الأصابع`,
                        `⏱️ استمر حتى يصبح الخليط مثل الرمل الخشن`,
                        `🎯 الهدف: قطع زبدة صغيرة مرئية للتقشير`
                    ],
                    creaming: [
                        `🌡️ دع الزبدة تصل لدرجة حرارة الغرفة (${this.data.MIXING_METHODS.creaming.butterTemp})`,
                        `🌀 اخفق الزبدة مع السكر حتى يصبح الخليط كريمي وفاتح`,
                        `⏱️ مدة الخفق: 3-4 دقائق بسرعة متوسطة`,
                        `🎯 الهدف: هواء محبوس لقوام طري`
                    ]
                };
                
                return steps[method] || steps.sablage;
            }
            
            generateRecommendations(state, profile) {
                const recommendations = [];
                
                if (state.mode === 'expert' && state.mixingMethod && state.mixingMethod !== profile.mixingMethod) {
                    recommendations.push({
                        title: '💡 ملاحظة: طريقة خلط مخصصة',
                        value: `تم استخدام ${this.data.MIXING_METHODS[state.mixingMethod].name} بدلاً من الطريقة الموصى بها`
                    });
                }
                
                if (state.butterType !== 'european' && profile.recommendedButter === 'european') {
                    recommendations.push({
                        title: '💡 تحسين مقترح',
                        value: 'لتحقيق نتائج أفضل، جرب الزبدة الأوروبية عالية الدسم'
                    });
                }
                
                // توصيات الإضافات
                if (state.textureType === 'tender' && !state.useCornstarch && state.mode === 'expert') {
                    recommendations.push({
                        title: '💡 تحسين الطراوة',
                        value: 'إضافة نشا الذرة ستحسن من القوام الطري'
                    });
                }
                
                if (state.textureType === 'crispy' && !state.useRiceFlour && state.mode === 'expert') {
                    recommendations.push({
                        title: '💡 تحسين القرمشة', 
                        value: 'إضافة دقيق الأرز ستعزز القرمشة'
                    });
                }
                
                return recommendations;
            }
            
            generateScientificReport(ingredients, state, profile) {
                return {
                    waterActivity: {
                        value: this.calculateWaterActivity(ingredients, state.butterType, profile.bakingTemp).value,
                        interpretation: this.interpretWaterActivity(parseFloat(this.calculateWaterActivity(ingredients, state.butterType, profile.bakingTemp).value))
                    },
                    texturePrediction: this.predictTexture(state, ingredients),
                    stability: this.calculateStability(state, ingredients)
                };
            }
            
            interpretWaterActivity(aw) {
                if (aw < 0.35) return 'مقرمش جداً مع عمر تخزين طويل';
                if (aw < 0.45) return 'متوازن مع عمر تخزين جيد';
                return 'طري مع عمر تخزين محدود';
            }
            
            predictTexture(state, ingredients) {
                const aw = parseFloat(this.calculateWaterActivity(ingredients, state.butterType, state.textureType === 'crispy' ? 177 : 149).value);
                const fatPercent = (ingredients.butter / (ingredients.flour + ingredients.butter + ingredients.sugar)) * 100;
                
                if (aw < 0.35 && fatPercent > 30) return 'مقرمش جداً مع طراوة داخلية';
                if (aw < 0.40 && fatPercent > 25) return 'مقرمش مع توازن جيد';
                if (aw < 0.45) return 'طري مع قرمشة خفيفة';
                return 'طري يذوب في الفم';
            }
            
            calculateStability(state, ingredients) {
                const aw = parseFloat(this.calculateWaterActivity(
                    ingredients, 
                    state.butterType, 
                    state.textureType === 'crispy' ? 177 : 149,
                    state.textureType === 'crispy'
                ).value);

                if (aw < 0.25) return 'استثنائية (45-60 يوم)';
                if (aw < 0.30) return 'عالية جداً (30-45 يوم)';
                if (aw < 0.35) return 'عالية (21-30 يوم)';
                if (aw < 0.40) return 'عالية (14-21 يوم)';
                if (aw < 0.45) return 'متوسطة (7-14 يوم)';
                return 'محدودة (3-7 أيام)';
            }
            
            generateCheckpoints(state) {
                const profile = this.data.PROFILES[state.textureType];
                const method = this.data.MIXING_METHODS[state.mixingMethod || profile.mixingMethod];
                
                return this.data.ENHANCED_CHECKPOINTS.map(checkpoint => {
                    const dynamicTarget = checkpoint.target.replace('{butterTemp}', method.butterTemp);
                    return {
                        ...checkpoint,
                        target: dynamicTarget
                    };
                });
            }
        }

        // ============================================
        // نظام التحذيرات المحسن
        // ============================================
        
        class WarningSystem {
            static SEVERITY = {
                CRITICAL: { color: '#dc2626', icon: '🚫', priority: 1 },
                HIGH: { color: '#ea580c', icon: '⚠️', priority: 2 },
                MEDIUM: { color: '#d97706', icon: '⚡', priority: 3 },
                INFO: { color: '#0891b2', icon: 'ℹ️', priority: 4 },
                SUCCESS: { color: '#059669', icon: '✅', priority: 5 }
            };
            
            static generateWarning(type, message, details = {}) {
                const severity = this.SEVERITY[type];
                
                return {
                    severity: severity,
                    message: message,
                    scientific: details.scientific || '',
                    recommendation: details.recommendation || '',
                    expectedIssue: details.expectedIssue || '',
                    expectedResult: details.expectedResult || ''
                };
            }
            
            static checkButterTypeCompatibility(state, profile) {
                const warnings = [];
                const butterInfo = ScientificData.BUTTER_TYPES[state.butterType];
                
                // تحليل شامل لتوافق نوع الزبدة
                if (state.butterType === 'vegetable') {
                    if (state.textureType === 'tender' || state.textureType === 'traditional') {
                        warnings.push(this.generateWarning('CRITICAL', 
                            `الزبدة النباتية غير متوافقة مع القوام ${profile.name}`, {
                            scientific: `محتوى الماء المنخفض جداً (${(butterInfo.waterContent * 100).toFixed(1)}%) يمنع تكوين الغلوتين الكافي للطراوة. الشورت بريد سيكون جافاً ومتفتتاً بشكل مفرط.`,
                            recommendation: 'استخدم زبدة أوروبية (82-84% دهون) أو أمريكية (80% دهون) للحصول على التوازن الصحيح بين الطراوة والهشاشة',
                            expectedIssue: 'جفاف شديد، تفتت زائد عن الحد، فقدان كامل لخاصية "الذوبان في الفم"، Aw منخفض جداً (<0.25)'
                        }));
                    } else if (state.textureType === 'crispy') {
                        warnings.push(this.generateWarning('SUCCESS',
                            `اختيار ممتاز! الزبدة النباتية مثالية للقوام المقرمش`, {
                            scientific: `محتوى الماء المنخفض (${(butterInfo.waterContent * 100).toFixed(1)}%) + الدهون العالية (${(butterInfo.fatContent * 100).toFixed(1)}%) = قرمشة استثنائية ومستدامة`,
                            expectedResult: `Aw منخفض جداً (0.20-0.30)، قرمشة تصدر صوتاً واضحاً، استقرار ممتاز، عمر تخزيني يصل إلى 60 يوماً في ظروف مثالية`
                        }));
                    }
                }
                
                if (state.butterType === 'american' && state.textureType === 'crispy') {
                    warnings.push(this.generateWarning('MEDIUM',
                        'الزبدة الأمريكية ستعطي قرمشة أقل من المتوقع', {
                        scientific: `محتوى الماء العالي (${(butterInfo.waterContent * 100).toFixed(1)}%) سينتج بخار إضافي أثناء الخبز، مما قد يقلل من القرمشة النهائية بنسبة 15-20%`,
                        recommendation: 'للحصول على أفضل نتائج للقوام المقرمش، استخدم زبدة أوروبية (82%+) أو نباتية (85%+)',
                        expectedIssue: 'قرمشة أقل، Aw أعلى (~0.35-0.40)، عمر تخزيني أقصر (14-21 يوم)'
                    }));
                }
                
                if (state.butterType === 'mixed') {
                    warnings.push(this.generateWarning('INFO',
                        'الزبدة المخلوطة خيار متوسط - نتائج متباينة', {
                        scientific: `مزيج من الزبدة والمارجرين ينتج خصائص متوسطة وغير متسقة. محتوى الماء (${(butterInfo.waterContent * 100).toFixed(1)}%) ومحتوى الدهون (${(butterInfo.fatContent * 100).toFixed(1)}%) يعتمدان على نسبة الخلط`,
                        recommendation: 'للحصول على نتائج موثوقة وقابلة للتكرار، استخدم نوعاً واحداً من الزبدة',
                        expectedIssue: 'نتائج غير متسقة بين دفعات مختلفة، صعوبة في التحكم الدقيق بالقوام النهائي'
                    }));
                }
                
                return warnings;
            }
            
            static checkAdditiveCompatibility(state, profile) {
                const warnings = [];
                
                // تحليل توافق المضافات
                if (state.textureType === 'tender' && state.useRiceFlour) {
                    warnings.push(this.generateWarning('MEDIUM',
                        'دقيق الأرز سيقلل من الطراوة المرغوبة', {
                        scientific: 'دقيق الأرز (خالي من الغلوتين) يزيد القرمشة بنسبة 30% ويقلل الطراوة. هذا عكس الهدف المطلوب للقوام الطري',
                        recommendation: 'للقوام الطري، استخدم نشا الذرة (12%) بدلاً من دقيق الأرز. نشا الذرة يعزز الطراوة دون زيادة القرمشة',
                        expectedIssue: 'قوام أكثر قرمشة وأقل طراوة من المتوقع، ملمس "رملي" بارز'
                    }));
                }
                
                if (state.textureType === 'crispy' && state.useCornstarch) {
                    warnings.push(this.generateWarning('MEDIUM',
                        'نشا الذرة قد يقلل من القرمشة المستهدفة', {
                        scientific: 'نشا الذرة النقي يذوب بسرعة ويخلق ملمساً ناعماً أكثر من كونه مقرمشاً. للقرمشة القصوى، دقيق الأرز الأبيض هو الخيار الأمثل',
                        recommendation: 'استخدم 25% دقيق أرز أبيض للحصول على قرمشة استثنائية (زيادة 30%)',
                        expectedIssue: 'قرمشة أقل من المثالية، ملمس أنعم وأقل "تقشراً"'
                    }));
                }
                
                if ((state.useRiceFlour && state.useCornstarch)) {
                    warnings.push(this.generateWarning('HIGH',
                        '⚠️ لا يجب استخدام دقيق الأرز ونشا الذرة معاً!', {
                        scientific: 'الجمع بين نوعين من النشويات يؤدي إلى إضعاف مفرط للغلوتين، مما ينتج عجيناً هشاً جداً يصعب التحكم به ويتفكك بسهولة',
                        recommendation: 'اختر واحداً فقط: نشا الذرة للطراوة، أو دقيق الأرز للقرمشة',
                        expectedIssue: 'عجين ضعيف جداً، تفتت مفرط، صعوبة في التشكيل، Aw غير مستقر'
                    }));
                }
                
                return warnings;
            }
        }

        // =============================================
        // إدارة الواجهة المحسنة
        // =============================================

        class UIManager {
            constructor() {
                this.stateManager = new AppState();
                this.recipeEngine = new RecipeEngine();
                this.init();
            }
            
            init() {
                // تهيئة الحالة الافتراضية
                this.stateManager.set('butterType', 'european');
                this.stateManager.set('textureType', 'traditional');
                this.stateManager.set('mode', 'beginner');
                this.stateManager.set('mixingMethod', 'sablage');
                
                this.bindEvents();
                this.updateModeDisplay();
                this.validateAndWarn();
                this.addTooltips();
                this.updateDimensions();
            }
            
            bindEvents() {
                // التنقل بين التبويبات
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.getAttribute('data-tab');
                        if (tabName === 'recipe' && document.getElementById('recipe-tab').disabled) {
                            this.showNotification('⚠️ يرجى حساب وصفة أولاً', 'error');
                            return;
                        }
                        this.switchTab(tabName);
                    });
                });
                
                // أحداث الشاشة الرئيسية
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mode = e.currentTarget.getAttribute('data-mode');
                        this.setMode(mode);
                    });
                });
                
                // أحداث الإعدادات
                document.getElementById('pan-shape').addEventListener('change', () => this.updateDimensions());
                document.getElementById('calculate-recipe-btn').addEventListener('click', () => this.calculateRecipe());
                document.getElementById('save-recipe-btn').addEventListener('click', () => this.saveCurrentRecipe());
                document.getElementById('export-all-btn').addEventListener('click', () => this.exportAllData());
                
                // أحداث الخيارات
                document.getElementById('use-rice-flour').addEventListener('change', (e) => {
                    this.stateManager.set('useRiceFlour', e.target.checked);
                    if (e.target.checked) {
                        document.getElementById('use-cornstarch').checked = false;
                        this.stateManager.set('useCornstarch', false);
                    }
                    this.validateAndWarn();
                });
                
                document.getElementById('use-cornstarch').addEventListener('change', (e) => {
                    this.stateManager.set('useCornstarch', e.target.checked);
                    if (e.target.checked) {
                        document.getElementById('use-rice-flour').checked = false;
                        this.stateManager.set('useRiceFlour', false);
                    }
                    this.validateAndWarn();
                });
                
                // Event listeners لطريقة الخلط
                document.querySelectorAll('#mixing-method-section .option-card').forEach(card => {
                    card.addEventListener('click', (event) => {
                        const method = event.currentTarget.getAttribute('data-method');
                        this.selectMixingMethod(method, event);
                    });
                });
                
                // الاشتراك في تحديثات الحالة
                this.stateManager.subscribe((key, value) => {
                    this.handleStateChange(key, value);
                });
            }
            
            setMode(mode) {
                this.stateManager.set('mode', mode);
                this.updateModeDisplay();
                this.validateAndWarn();
                
                this.showNotification(`✅ تم التبديل إلى وضع ${mode === 'beginner' ? 'المبتدئ' : 'الخبير'}`);
            }
            
            updateModeDisplay() {
                const mode = this.stateManager.get('mode');
                const modeDisplay = document.getElementById('current-mode-display');
                const expertExplanation = document.getElementById('expert-explanation');
                const mixingSection = document.getElementById('mixing-method-section');
                
                if (modeDisplay) {
                    modeDisplay.textContent = mode === 'beginner' ? 'المبتدئ' : 'الخبير';
                }
                
                // تحديث أزرار الوضع
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-mode') === mode) {
                        btn.classList.add('active');
                    }
                });
                
                // إظهار/إخفاء شرح الوضع الخبير
                if (expertExplanation) {
                    expertExplanation.classList.toggle('hidden', mode !== 'expert');
                }
                
                // إظهار/إخفاء قسم نظام الخلط
                if (mixingSection) {
                    mixingSection.classList.toggle('hidden', mode !== 'expert');
                }
                
                // تحديث التوصيات
                this.validateAndWarn();
            }
            
            updateDimensions() {
                const shape = document.getElementById('pan-shape').value;
                this.stateManager.set('panShape', shape);
                
                // حفظ القيم الحالية
                if (shape === 'rectangular') {
                    const length = parseInt(document.getElementById('pan-length').value) || 30;
                    const width = parseInt(document.getElementById('pan-width').value) || 20;
                    this.stateManager.set('dimensions', { 
                        ...this.stateManager.get('dimensions'),
                        length, 
                        width 
                    });
                    document.getElementById('rectangular-dimensions').classList.remove('hidden');
                    document.getElementById('circular-dimensions').classList.add('hidden');
                } else {
                    const diameter = parseInt(document.getElementById('pan-diameter').value) || 24;
                    this.stateManager.set('dimensions', { 
                        ...this.stateManager.get('dimensions'),
                        diameter 
                    });
                    document.getElementById('rectangular-dimensions').classList.add('hidden');
                    document.getElementById('circular-dimensions').classList.remove('hidden');
                }
            }
            
            selectTexture(texture) {
                this.stateManager.set('textureType', texture);
                
                // تحديث الواجهة
                document.querySelectorAll('[id^="texture-"]').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById(`texture-${texture}`).classList.add('selected');
                
                // في وضع المبتدئ، تطبيق التوصيات تلقائياً
                if (this.stateManager.get('mode') === 'beginner') {
                    this.applyAutomaticRecommendations();
                }
                
                this.validateAndWarn();
            }
            
            applyAutomaticRecommendations() {
                const state = this.stateManager.state;
                const profile = ScientificData.PROFILES[state.textureType];
                
                // تحديث خيارات الإضافات تلقائياً
                document.getElementById('use-rice-flour').checked = profile.additive.type === 'riceFlour';
                document.getElementById('use-cornstarch').checked = profile.additive.type === 'cornstarch';
                
                this.stateManager.set('useRiceFlour', profile.additive.type === 'riceFlour');
                this.stateManager.set('useCornstarch', profile.additive.type === 'cornstarch');
                this.stateManager.set('butterType', profile.recommendedButter || 'european');
                this.stateManager.set('mixingMethod', profile.mixingMethod);
                
                // تحديث واجهة الزبدة
                document.querySelectorAll('[id^="butter-"]').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById(`butter-${profile.recommendedButter || 'european'}`).classList.add('selected');
                
                // تحديث واجهة طريقة الخلط
                document.querySelectorAll('#mixing-method-section .option-card').forEach(card => {
                    card.classList.remove('selected');
                });
                const mixingCard = document.querySelector(`[data-method="${profile.mixingMethod}"]`);
                if (mixingCard) mixingCard.classList.add('selected');
            }
            
            selectQuickProfile(profile) {
                this.selectTexture(profile);
                this.switchTab('setup');
            }
            
            selectButter(butterType) {
                this.stateManager.set('butterType', butterType);
                
                document.querySelectorAll('[id^="butter-"]').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById(`butter-${butterType}`).classList.add('selected');
                
                this.validateAndWarn();
            }
            
            selectMixingMethod(method, event) {
                if (this.stateManager.get('mode') === 'expert') {
                    this.stateManager.set('mixingMethod', method);
                    
                    document.querySelectorAll('#mixing-method-section .option-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    if (event && event.currentTarget) {
                        event.currentTarget.classList.add('selected');
                    }
                    
                    this.validateAndWarn();
                    this.showNotification(`✅ تم تغيير طريقة الخلط إلى ${ScientificData.MIXING_METHODS[method].name}`);
                }
            }
            
            validateAndWarn() {
                const state = this.stateManager.state;
                const profile = ScientificData.PROFILES[state.textureType];
                const container = document.getElementById('smart-recommendations-container');
                
                if (!container) return;
                
                // جمع جميع التحذيرات
                let allWarnings = [];
                allWarnings = allWarnings.concat(WarningSystem.checkButterTypeCompatibility(state, profile));
                allWarnings = allWarnings.concat(WarningSystem.checkAdditiveCompatibility(state, profile));
                
                // ترتيب التحذيرات حسب الأولوية
                allWarnings.sort((a, b) => a.severity.priority - b.severity.priority);
                
                let html = `
                    <div class="recommendation-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">🎯</div>
                            <div>
                                <div class="font-bold">البروفايل المحدد: ${profile.name}</div>
                                <div class="text-sm text-green-700">${profile.description}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // عرض التحذيرات
                if (allWarnings.length > 0) {
                    allWarnings.forEach(warning => {
                        html += `
                            <div class="warning-card" style="background: ${warning.severity.color}15; border: 2px solid ${warning.severity.color}; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                                    <div style="font-size: 2rem; flex-shrink: 0;">${warning.severity.icon}</div>
                                    <div style="flex: 1;">
                                        <h4 style="color: ${warning.severity.color}; margin: 0 0 0.75rem 0; font-weight: bold; font-size: 1.1rem;">
                                            ${warning.message}
                                        </h4>
                                        
                                        ${warning.scientific ? `
                                            <div style="background: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; border-right: 3px solid ${warning.severity.color};">
                                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">🔬 الأساس العلمي:</div>
                                                <div style="color: #4b5563; font-size: 0.9rem;">${warning.scientific}</div>
                                            </div>
                                        ` : ''}
                                        
                                        ${warning.recommendation ? `
                                            <div style="background: #ecfdf5; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; border-right: 3px solid #059669;">
                                                <div style="font-weight: 600; color: #059669; margin-bottom: 0.25rem;">💡 التوصية:</div>
                                                <div style="color: #065f46; font-size: 0.9rem;">${warning.recommendation}</div>
                                            </div>
                                        ` : ''}
                                        
                                        ${warning.expectedIssue ? `
                                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; border-right: 3px solid #d97706;">
                                                <div style="font-weight: 600; color: #d97706; margin-bottom: 0.25rem;">⚠️ المشكلة المتوقعة:</div>
                                                <div style="color: #92400e; font-size: 0.9rem;">${warning.expectedIssue}</div>
                                            </div>
                                        ` : ''}
                                        
                                        ${warning.expectedResult ? `
                                            <div style="background: #dbeafe; padding: 0.75rem; border-radius: 8px; border-right: 3px solid #3b82f6;">
                                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">✨ النتيجة المتوقعة:</div>
                                                <div style="color: #1e3a8a; font-size: 0.9rem;">${warning.expectedResult}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                this.updateAutoSettingsDisplay(profile);
            }
            
            updateAutoSettingsDisplay(profile) {
                const container = document.getElementById('auto-settings-display');
                const state = this.stateManager.state;
                const effectiveMethod = state.mixingMethod || profile.mixingMethod;
                const methodInfo = ScientificData.MIXING_METHODS[effectiveMethod];
                
                if (!container) return;
                
                container.innerHTML = `
                    <div class="grid-2">
                        <div class="auto-settings">
                            <div class="font-semibold">طريقة الخلط</div>
                            <div class="text-sm text-gray-600">${methodInfo.name}</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">نوع السكر</div>
                            <div class="text-sm text-gray-600">${profile.sugarType === 'powdered' ? 'بودرة' : 'محبب'}</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">المضافات</div>
                            <div class="text-sm text-gray-600">${
                                profile.additive.type === 'none' ? 'بدون' : 
                                profile.additive.type === 'cornstarch' ? 'نشا ذرة 15%' : 
                                'دقيق أرز 25%'
                            }</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">درجة حرارة الزبدة</div>
                            <div class="text-sm text-gray-600">${profile.butterTemp}</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">درجة حرارة الخبز</div>
                            <div class="text-sm text-gray-600">${profile.bakingTemp}°م</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">مدة الخبز</div>
                            <div class="text-sm text-gray-600">${profile.bakingTime}</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">نوع الزبدة الموصى به</div>
                            <div class="text-sm text-gray-600">${ScientificData.BUTTER_TYPES[profile.recommendedButter || 'european'].name}</div>
                        </div>
                        <div class="auto-settings">
                            <div class="font-semibold">الكثافة المتوقعة</div>
                            <div class="text-sm text-gray-600">${profile.density} جم/سم³</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="font-semibold text-blue-900">📝 التعليمات الخاصة:</div>
                        <ul class="text-sm text-blue-700 mt-2 space-y-1">
                            ${profile.specialInstructions.map(instruction => `
                                <li>• ${instruction}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
                // تحديث طريقة الخلط الموصى بها
                const recommendedMethod = document.getElementById('recommended-mixing-method');
                if (recommendedMethod) {
                    recommendedMethod.textContent = `${ScientificData.MIXING_METHODS[profile.mixingMethod].name} (موصى به)`;
                }
            }
            
            calculateRecipe() {
                // تحديث الحالة من الواجهة
                this.updateStateFromUI();
                
                // التحقق من المدخلات
                if (!this.validateInputs()) return;
                
                this.showLoading();
                
                // محاكاة حساب غير متزامن
                setTimeout(() => {
                    try {
                        const state = this.stateManager.state;
                        const recipe = this.recipeEngine.calculateRecipe(state);
                        
                        if (!recipe) {
                            throw new Error('فشل في حساب الوصفة');
                        }
                        
                        this.stateManager.set('currentRecipe', recipe);
                        
                        // ✅ تحديث الواجهة إذا تم تطبيق توصيات تلقائية
                        if (state.mode === 'beginner') {
                            this.updateUIFromState();
                        }
                        
                        // تمكين تبويب الوصفة
                        document.getElementById('recipe-tab').disabled = false;
                        
                        // عرض الوصفة
                        this.renderRecipe();
                        this.switchTab('recipe');
                        
                        this.hideLoading();
                        this.showNotification('✅ تم حساب الوصفة بنجاح مع التحسينات العلمية!');
                    } catch (error) {
                        console.error('Error calculating recipe:', error);
                        this.hideLoading();
                        this.showNotification('❌ حدث خطأ في حساب الوصفة', 'error');
                    }
                }, 1000);
            }
            
            updateStateFromUI() {
                const state = {
                    panShape: document.getElementById('pan-shape').value,
                    dimensions: {
                        length: parseInt(document.getElementById('pan-length').value) || 30,
                        width: parseInt(document.getElementById('pan-width').value) || 20,
                        diameter: parseInt(document.getElementById('pan-diameter').value) || 24
                    },
                    height: parseFloat(document.getElementById('pan-height').value) || 1.5,
                    textureType: this.stateManager.get('textureType'),
                    butterType: this.stateManager.get('butterType'),
                    mixingMethod: this.stateManager.get('mixingMethod'),
                    useRiceFlour: document.getElementById('use-rice-flour').checked,
                    useCornstarch: document.getElementById('use-cornstarch').checked
                };
                
                this.stateManager.update(state);
            }
            
            validateInputs() {
                const length = parseInt(document.getElementById('pan-length').value);
                const width = parseInt(document.getElementById('pan-width').value);
                const height = parseFloat(document.getElementById('pan-height').value);
                
                if (this.stateManager.get('panShape') === 'rectangular') {
                    if (length < 10 || length > 50) {
                        this.showNotification('الطول يجب أن يكون بين 10 و 50 سم', 'error');
                        return false;
                    }
                    
                    if (width < 10 || width > 50) {
                        this.showNotification('العرض يجب أن يكون بين 10 و 50 سم', 'error');
                        return false;
                    }
                }
                
                if (height < 0.5 || height > 3.0) {
                    this.showNotification('الارتفاع يجب أن يكون بين 0.5 و 3.0 سم', 'error');
                    return false;
                }
                
                return true;
            }
            
            renderRecipe() {
                const recipe = this.stateManager.get('currentRecipe');
                if (!recipe) return;
                
                // تحديث الإحصائيات
                document.getElementById('stat-weight').textContent = `${recipe.analysis.weight}غم`;
                document.getElementById('stat-fat').textContent = `${recipe.analysis.fatPercent}%`;
                document.getElementById('stat-aw').textContent = recipe.analysis.expectedAw;
                document.getElementById('stat-shelf').textContent = recipe.analysis.shelfLife;
                
                // تحديث المكونات
                this.renderIngredients(recipe);
                
                // تحديث التعليمات
                this.renderInstructions(recipe);
            }
            
            renderIngredients(recipe) {
                const container = document.getElementById('ingredients-list');
                if (!container || !recipe) return;

                // الحصول على نوع الزبدة مع قيمة افتراضية
                const butterType = this.stateManager.get('butterType') || 'european';
                const butterInfo = ScientificData.BUTTER_TYPES[butterType];
                
                // استخدام اسم افتراضي إذا لم يكن butterInfo موجوداً
                const butterName = butterInfo ? butterInfo.name : 'زبدة';

                const ingredients = [
                    { 
                        name: 'الزبدة', 
                        amount: `${recipe.ingredients.butter}غم`, 
                        note: `${butterName} - ${recipe.analysis.recommendedButterTemp}`
                    },
                    { 
                        name: 'الدقيق', 
                        amount: `${recipe.ingredients.flour}غم`, 
                        note: 'طريقة Spoon & Level' 
                    },
                    { 
                        name: 'السكر', 
                        amount: `${recipe.ingredients.sugar}غم`, 
                        note: recipe.profile.sugarType === 'powdered' ? 'بودرة للطراوة' : 'محبب للقرمشة' 
                    },
                    { 
                        name: 'الملح', 
                        amount: `${recipe.ingredients.salt}غم`, 
                        note: 'ملح بحري ناعم - 1% من الدقيق' 
                    }
                ];

                let html = '';
                
                ingredients.forEach(ing => {
                    html += `
                        <div class="ingredient-card">
                            <div class="ingredient-header">
                                <div>
                                    <div class="ingredient-name">${ing.name}</div>
                                    <div class="ingredient-note">${ing.note}</div>
                                </div>
                                <div class="ingredient-amount">${ing.amount}</div>
                            </div>
                        </div>
                    `;
                });
                
                // إضافة المضافات إذا وجدت
                if (recipe.ingredients.additives) {
                    Object.entries(recipe.ingredients.additives).forEach(([name, amount]) => {
                        if (amount > 0) {
                            html += `
                                <div class="ingredient-card additive">
                                    <div class="ingredient-header">
                                        <div>
                                            <div class="ingredient-name">${name}</div>
                                            <div class="ingredient-note">إضافة علمية لتحسين القوام</div>
                                        </div>
                                        <div class="ingredient-amount">${amount}غم</div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                container.innerHTML = html;
            }
            
            renderInstructions(recipe) {
                const container = document.getElementById('instructions-container');
                if (!container) return;
                
                let html = '';
                
                if (recipe.instructions.mixing) {
                    const method = ScientificData.MIXING_METHODS[this.stateManager.get('mixingMethod') || recipe.profile.mixingMethod];
                    
                    html += `
                        <div class="card card-blue">
                            <h3 class="subsection-title">${recipe.instructions.mixing.title}</h3>
                            <div class="method-details" style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-right: 4px solid #3b82f6; margin-bottom: 1rem;">
                                <div class="method-detail-item" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span class="method-detail-label" style="color: #4b5563; font-weight: 500;">🔬 الأساس العلمي:</span>
                                    <span class="method-detail-value" style="color: #1f2937; font-weight: 600;">${recipe.instructions.mixing.scientificBasis}</span>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-number">1</div>
                                    <div style="flex: 1;">
                                        <div class="step-action">خطوات الخلط</div>
                                        ${recipe.instructions.mixing.steps.map(step => `
                                            <div class="step-detail">${step}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // إضافة قسم التوصيات
                if (recipe.recommendations && recipe.recommendations.length > 0) {
                    html += `
                        <div class="card card-purple">
                            <h3 class="subsection-title">🧠 التوصيات الذكية المحسنة</h3>
                            ${recipe.recommendations.map(rec => `
                                <div class="method-details" style="background: #faf5ff; padding: 1rem; border-radius: 8px; border-right: 4px solid #8b5cf6; margin-bottom: 0.75rem;">
                                    <div class="method-detail-item" style="display: flex; justify-content: space-between;">
                                        <span class="method-detail-label" style="color: #4b5563; font-weight: 500;">${rec.title}</span>
                                        <span class="method-detail-value" style="color: #1f2937; font-weight: 600;">${rec.value}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // إضافة قسم الخبز المزدوج للقوام المقرمش
                if (recipe.profile.twiceBaked && recipe.profile.twiceBaked.enabled) {
                    html += `
                        <div class="card card-red">
                            <h3 class="subsection-title">🔥 تقنية الخبز المزدوج المحسنة - سر القرمشة الاستثنائية</h3>
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-number">4</div>
                                    <div style="flex: 1;">
                                        <div class="step-action">المرحلة الأولى: الخبز الأساسي</div>
                                        <div class="step-detail">
                                            اخبز على حرارة ${recipe.profile.twiceBaked.firstBakeTemp}°م
                                        </div>
                                        <div class="step-detail">
                                            <strong>المدة:</strong> ${recipe.profile.twiceBaked.firstBakeDuration}
                                        </div>
                                        <div class="step-detail">
                                            <strong>الهدف:</strong> تثبيت الهيكل وتكوين اللون الذهبي
                                        </div>
                                        <div class="step-tip">
                                            🔬 درجة الحرارة العالية تنشط تفاعلات ميلارد لتكوين النكهة واللون
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-number">5</div>
                                    <div style="flex: 1;">
                                        <div class="step-action">المرحلة الثانية: التجفيف بالحرارة المتبقية</div>
                                        <div class="step-detail">
                                            أطفئ الفرن واترك الباب مفتوحاً قليلاً
                                        </div>
                                        <div class="step-detail">
                                            <strong>التبريد:</strong> ${recipe.profile.twiceBaked.coolingDuration}
                                        </div>
                                        <div class="step-detail">
                                            قطع الشورت بريد إلى القطع المطلوبة وهو دافئ
                                        </div>
                                        <div class="step-tip">
                                            💡 القطع أثناء الدفء يمنع التكسر ويعطي حوافاً نظيفة
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-number">6</div>
                                    <div style="flex: 1;">
                                        <div class="step-action">المرحلة الثالثة: التحميص النهائي</div>
                                        <div class="step-detail">
                                            أعد القطع المقطوعة إلى الفرن المطفأ
                                        </div>
                                        <div class="step-detail">
                                            <strong>المدة:</strong> ${recipe.profile.twiceBaked.secondBakeDuration}
                                        </div>
                                        <div class="step-detail">
                                            <strong>الآلية:</strong> الحرارة المتبقية تجفف العجين تدريجياً
                                        </div>
                                        <div class="step-tip">
                                            🔬 هذه المرحلة تخفض Aw من ~0.40 إلى <0.30، مما يضمن قرمشة تدوم أسابيع
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #ecfdf5; border: 2px solid #059669; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                                <div style="font-weight: bold; color: #059669; margin-bottom: 0.5rem;">
                                    ✅ النتيجة المتوقعة:
                                </div>
                                <ul style="color: #065f46; margin: 0; padding-right: 1.5rem;">
                                    <li>قرمشة استثنائية تصدر صوتاً عند الكسر</li>
                                    <li>طبقات متقشرة واضحة للعيان</li>
                                    <li>لون ذهبي عميق متساوٍ</li>
                                    <li>عمر تخزيني 30-45 يوم في وعاء محكم</li>
                                    <li>Aw نهائي: ${recipe.profile.expectedAw}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // قسم التقرير العلمي
                html += `
                    <div class="card card-green">
                        <h3 class="subsection-title">🔬 التقرير العلمي المتقدم</h3>
                        <div class="grid-2">
                            <div class="stat-card">
                                <div class="stat-icon">🌡️</div>
                                <div class="stat-label">نشاط الماء (Aw)</div>
                                <div class="stat-value">${recipe.scientificReport.waterActivity.value}</div>
                                <div class="text-sm text-gray-600 mt-1">${recipe.scientificReport.waterActivity.interpretation}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">📊</div>
                                <div class="stat-label">توقع القوام</div>
                                <div class="stat-value">${recipe.scientificReport.texturePrediction}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🛡️</div>
                                <div class="stat-label">الاستقرار</div>
                                <div class="stat-value">${recipe.scientificReport.stability}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">⚖️</div>
                                <div class="stat-label">الكثافة</div>
                                <div class="stat-value">${recipe.analysis.density.toFixed(2)} جم/سم³</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // التعليمات العامة
                html += `
                    <div class="card card-green">
                        <h3 class="subsection-title">📝 التعليمات العامة المحسنة</h3>
                        <div class="step-card">
                            <div class="step-header">
                                <div class="step-number">2</div>
                                <div style="flex: 1;">
                                    <div class="step-action">التشكيل والتبريد</div>
                                    <div class="step-detail">اضغط العجين في الصينية بشكل متساوٍ</div>
                                    <div class="step-detail">اخرم السطح بالشوكة لمنع الانتفاخ</div>
                                    <div class="step-detail">برد لمدة ساعتين على الأقل</div>
                                    <div class="step-tip">💡 التبريد الكافي يمنع انتشار العجين ويحسن القوام</div>
                                </div>
                            </div>
                        </div>
                        <div class="step-card">
                            <div class="step-header">
                                <div class="step-number">3</div>
                                <div style="flex: 1;">
                                    <div class="step-action">الخبز</div>
                                    <div class="step-detail">اخبز على حرارة ${recipe.analysis.optimalBaking}</div>
                                    <div class="step-detail">افحص الحواف بعد 15 دقيقة</div>
                                    <div class="step-detail">انتظر حتى تبرد تماماً قبل التقطيع</div>
                                    <div class="step-tip">💡 التبريد الكامل قبل التقطيع يمنع التكسر</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            switchTab(tabName) {
                // إخفاء جميع المحتويات
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // إلغاء تنشيط جميع الأزرار
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // إظهار المحتوى المطلوب
                const targetScreen = document.getElementById(`${tabName}-screen`);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                }
                
                // تنشيط الزر المطلوب
                const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
                
                // تحميل محتوى التبويب إذا لزم
                this.loadTabContent(tabName);
            }
            
            loadTabContent(tabName) {
                switch(tabName) {
                    case 'setup':
                        this.validateAndWarn();
                        break;
                    case 'checkpoints':
                        this.renderCheckpoints();
                        break;
                    case 'troubleshoot':
                        this.renderTroubleshooting();
                        break;
                    case 'library':
                        this.renderLibrary();
                        break;
                    case 'analyzer':
                        this.initAnalyzer();
                        break;
                }
            }
            
            initAnalyzer() {
                // تعطيل جميع الحقول في البداية
                const ingredients = ['flour', 'butter', 'sugar', 'rice-flour', 'cornstarch', 'salt'];
                ingredients.forEach(ingredient => {
                    const input = document.getElementById(ingredient);
                    if (input) {
                        input.disabled = true;
                        input.value = '';
                    }
                });
                
                // إعادة تعيين التحديدات
                currentMixingMethod = null;
                currentButterType = null;
                currentSugarType = null;
                
                // إزالة التحديد من جميع الأزرار
                document.querySelectorAll('#analyzer-screen .option-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // إعادة تعيين النتائج
                const resultsContainer = document.getElementById('manual-analysis-results');
                if (resultsContainer) {
                    resultsContainer.classList.add('hidden');
                    resultsContainer.innerHTML = '';
                }
                
                // إعادة تعيين checkboxes المكونات
                document.getElementById('has-flour').checked = false;
                document.getElementById('has-butter').checked = false;
                document.getElementById('has-sugar').checked = false;
                document.getElementById('has-rice-flour').checked = false;
                document.getElementById('has-cornstarch').checked = false;
                document.getElementById('has-salt').checked = false;
                
                // إعادة تعيين checkboxes التقنيات
                document.getElementById('has-chilling').checked = false;
                document.getElementById('has-docking').checked = false;
                document.getElementById('has-twice-baked').checked = false;
                document.getElementById('has-vanilla').checked = false;
                
                // إعادة تعيين إعدادات الخبز
                document.getElementById('baking-temp').value = '';
                document.getElementById('baking-time').value = '';
            }
            
            renderCheckpoints() {
                const container = document.getElementById('checkpoints-list');
                const completedCount = document.getElementById('completed-count');
                const state = this.stateManager.state;
                
                if (!container) return;
                
                const checkpoints = this.recipeEngine.generateCheckpoints(state);
                const completed = state.completedCheckpoints || [];
                
                container.innerHTML = '';
                
                // تحديث العداد
                if (completedCount) {
                    completedCount.textContent = `${completed.length}/${checkpoints.length}`;
                }
                
                checkpoints.forEach((checkpoint, index) => {
                    const isCompleted = completed.includes(index);
                    
                    const checkpointElement = document.createElement('div');
                    checkpointElement.className = `checkpoint-card ${isCompleted ? 'completed' : ''}`;
                    checkpointElement.innerHTML = `
                        <div class="checkpoint-content">
                            <div class="checkpoint-header">
                                <button class="checkpoint-toggle ${isCompleted ? 'completed' : ''}" onclick="uiManager.toggleCheckpoint(${index})">
                                    ${isCompleted ? '✓' : ''}
                                </button>
                                <div style="flex: 1;">
                                    <div class="checkpoint-timing">
                                        <span>⏰</span>
                                        <span class="font-bold text-amber-700">${checkpoint.timing}</span>
                                    </div>
                                    <h3 class="checkpoint-title">${checkpoint.check}</h3>
                                    <div class="checkpoint-grid">
                                        <div class="checkpoint-target">
                                            <div class="font-semibold text-green-900 mb-2">🎯 الهدف:</div>
                                            <div class="text-green-800">${checkpoint.target}</div>
                                        </div>
                                        <div class="checkpoint-test">
                                            <div class="font-semibold text-blue-900 mb-2">🔍 طريقة الاختبار:</div>
                                            <div class="text-blue-800">${checkpoint.test}</div>
                                        </div>
                                    </div>
                                    <div class="checkpoint-why">
                                        <div class="font-semibold text-purple-900 mb-2">🔬 لماذا هذا مهم:</div>
                                        <div class="text-purple-800">${checkpoint.whyItMatters}</div>
                                    </div>
                                    <div class="checkpoint-fix">
                                        <div class="font-semibold text-yellow-900 mb-2">🔧 الحل إذا فشل الاختبار:</div>
                                        <div class="text-yellow-800">${checkpoint.fix}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(checkpointElement);
                });
            }
            
            toggleCheckpoint(index) {
                let completed = this.stateManager.get('completedCheckpoints') || [];
                
                if (completed.includes(index)) {
                    completed = completed.filter(i => i !== index);
                } else {
                    completed.push(index);
                }
                
                this.stateManager.set('completedCheckpoints', completed);
                this.renderCheckpoints();
            }
            
            renderLibrary() {
                const recipeGrid = document.getElementById('recipe-grid');
                const emptyLibrary = document.getElementById('empty-library');
                const libraryCount = document.getElementById('library-count');
                const successRate = document.getElementById('success-rate');
                
                if (!recipeGrid || !emptyLibrary) return;
                
                const savedRecipes = this.getSavedRecipes();
                
                if (savedRecipes.length === 0) {
                    recipeGrid.classList.add('hidden');
                    emptyLibrary.classList.remove('hidden');
                    
                    if (libraryCount) libraryCount.textContent = '0';
                    if (successRate) successRate.textContent = '0%';
                    return;
                }
                
                recipeGrid.classList.remove('hidden');
                emptyLibrary.classList.add('hidden');
                
                if (libraryCount) libraryCount.textContent = savedRecipes.length;
                if (successRate) {
                    const ratedRecipes = savedRecipes.filter(r => r.rating);
                    const successRateValue = ratedRecipes.length > 0 ? 
                        Math.round((ratedRecipes.filter(r => r.rating.overall >= 4).length / ratedRecipes.length) * 100) : 0;
                    successRate.textContent = `${successRateValue}%`;
                }
                
                recipeGrid.innerHTML = savedRecipes.map(recipe => `
                    <div class="recipe-card" data-recipe-id="${recipe.id}">
                        <div class="recipe-header">
                            <h3 style="margin: 0;">${recipe.name}</h3>
                            <div class="recipe-meta">
                                <span class="date" style="color: var(--text-light); font-size: 0.875rem;">${new Date(recipe.timestamp).toLocaleDateString('ar-EG')}</span>
                                ${recipe.rating ? `
                                    <span class="rating" style="color: var(--primary-color); font-weight: bold;">
                                        ${'★'.repeat(Math.round(recipe.rating.overall))}${'☆'.repeat(5-Math.round(recipe.rating.overall))}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="recipe-preview">
                            <div class="preview-stats">
                                <span>⚖️ ${recipe.recipe.analysis.weight}غم</span>
                                <span>🎯 ${recipe.profile}</span>
                                ${recipe.rating ? `<span>⭐ ${recipe.rating.overall}/5</span>` : ''}
                            </div>
                            <div class="recipe-actions">
                                <button class="btn" onclick="uiManager.loadRecipe('${recipe.id}')" style="background: var(--primary-color); color: white;">🔄 استعاده</button>
                                <button class="btn" onclick="uiManager.exportRecipe('${recipe.id}')" style="background: var(--secondary-color); color: white;">📤 تصدير</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            getSavedRecipes() {
                try {
                    return JSON.parse(localStorage.getItem('shortbreadRecipes')) || [];
                } catch (error) {
                    console.error('Error loading saved recipes:', error);
                    return [];
                }
            }
            
            saveCurrentRecipe() {
                const recipe = this.stateManager.get('currentRecipe');
                if (!recipe) {
                    this.showNotification('⚠️ يرجى حساب وصفة أولاً', 'error');
                    return;
                }
                
                const recipeName = prompt('أدخل اسم للوصفة:', `وصفة شورت بريد ${new Date().toLocaleDateString('ar-EG')}`);
                if (!recipeName) return;
                
                const savedRecipe = {
                    id: 'recipe_' + Date.now(),
                    name: recipeName,
                    timestamp: new Date().toISOString(),
                    state: JSON.parse(JSON.stringify(this.stateManager.state)),
                    recipe: JSON.parse(JSON.stringify(recipe)),
                    profile: recipe.profile.name
                };
                
                const savedRecipes = this.getSavedRecipes();
                savedRecipes.unshift(savedRecipe);
                
                try {
                    localStorage.setItem('shortbreadRecipes', JSON.stringify(savedRecipes));
                    this.showNotification('✅ تم حفظ الوصفة بنجاح في مكتبتك!');
                    this.renderLibrary();
                    
                    // عرض خيار التقييم بعد حفظ الوصفة
                    setTimeout(() => {
                        this.showRatingPrompt(savedRecipe.id);
                    }, 1000);
                } catch (error) {
                    this.showNotification('❌ خطأ في حفظ الوصفة - قد يكون التخزين ممتلئاً', 'error');
                    console.error('Error saving recipe:', error);
                }
            }
            
            showRatingPrompt(recipeId) {
                const rating = prompt(`كيف تقيم هذه الوصفة؟

⭐ ⭐ ⭐ ⭐ ⭐ (ممتاز)
⭐ ⭐ ⭐ ⭐ (جيد جداً)  
⭐ ⭐ ⭐ (جيد)
⭐ ⭐ (مقبول)
⭐ (ضعيف)

أدخل تقييمك من 1 إلى 5:`);
                
                if (rating && !isNaN(rating) && rating >= 1 && rating <= 5) {
                    this.rateRecipe(recipeId, parseInt(rating));
                }
            }
            
            rateRecipe(recipeId, rating) {
                const savedRecipes = this.getSavedRecipes();
                const recipe = savedRecipes.find(r => r.id === recipeId);
                
                if (recipe) {
                    recipe.rating = {
                        overall: rating,
                        texture: null,
                        flavor: null,
                        ease: null,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem('shortbreadRecipes', JSON.stringify(savedRecipes));
                    this.showNotification(`✅ تم حفظ تقييمك: ${rating}/5`);
                    this.renderLibrary();
                }
            }
            
            loadRecipe(recipeId) {
                const savedRecipes = this.getSavedRecipes();
                const recipe = savedRecipes.find(r => r.id === recipeId);
                
                if (recipe) {
                    this.stateManager.update(recipe.state);
                    this.stateManager.set('currentRecipe', recipe.recipe);
                    
                    // تحديث الواجهة
                    this.updateUIFromState();
                    this.renderRecipe();
                    this.switchTab('recipe');
                    
                    this.showNotification(`✅ تم تحميل الوصفة: ${recipe.name}`);
                }
            }
            
            updateUIFromState() {
                const state = this.stateManager.state;
                
                // تحديث اختيارات القوام
                document.querySelectorAll('[id^="texture-"]').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById(`texture-${state.textureType}`)?.classList.add('selected');
                
                // تحديث اختيارات الزبدة
                document.querySelectorAll('[id^="butter-"]').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById(`butter-${state.butterType}`)?.classList.add('selected');
                
                // تحديث الخيارات الإضافية
                document.getElementById('use-rice-flour').checked = state.useRiceFlour;
                document.getElementById('use-cornstarch').checked = state.useCornstarch;
                
                // تحديث طريقة الخلط (في وضع الخبير)
                if (state.mode === 'expert' && state.mixingMethod) {
                    document.querySelectorAll('#mixing-method-section .option-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    const selectedCard = document.querySelector(`[data-method="${state.mixingMethod}"]`);
                    if (selectedCard) selectedCard.classList.add('selected');
                }
                
                // تحديث الأبعاد
                document.getElementById('pan-shape').value = state.panShape;
                document.getElementById('pan-length').value = state.dimensions.length;
                document.getElementById('pan-width').value = state.dimensions.width;
                document.getElementById('pan-diameter').value = state.dimensions.diameter;
                document.getElementById('pan-height').value = state.height;
                
                this.updateDimensions();
                this.validateAndWarn();
            }
            
            exportRecipe(recipeId) {
                const savedRecipes = this.getSavedRecipes();
                const recipe = savedRecipes.find(r => r.id === recipeId);
                
                if (recipe) {
                    const dataStr = JSON.stringify(recipe, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    
                    const link = document.createElement('a');
                    link.setAttribute('href', dataUri);
                    link.setAttribute('download', `shortbread_recipe_${recipe.id}.json`);
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('✅ تم تصدير الوصفة بنجاح');
                }
            }
            
            exportAllData() {
                const savedRecipes = this.getSavedRecipes();
                const exportData = {
                    recipes: savedRecipes,
                    exportInfo: {
                        version: '2.0',
                        exportedAt: new Date().toISOString(),
                        totalRecipes: savedRecipes.length,
                        appName: 'مهندس الشورت بريد العلمي المحسن'
                    }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `shortbread_backup_${Date.now()}.json`);
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('✅ تم تصدير جميع البيانات بنجاح');
            }
            
            renderTroubleshooting() {
                const container = document.getElementById('troubleshoot-list');
                if (!container) return;
                
                const issues = [
                    {
                        problem: 'انتشر بشكل مفرط (أصبح رقيقاً جداً)',
                        severity: 'عالية',
                        diagnosis: {
                            cause: 'الزبدة كانت دافئة جداً أو طريقة الخلط غير مناسبة',
                            scientific: `درجة حرارة الزبدة غير مناسبة لطريقة الخلط المختارة أو نوع الزبدة`,
                            howToKnow: 'قطر القطعة >5% أكبر من الصينية'
                        },
                        prevention: {
                            title: '🛡️ الوقاية (للمرة القادمة):',
                            steps: [
                                'استخدم درجة الحرارة المناسبة لطريقة الخلط',
                                'برد العجين 4 ساعات على الأقل',
                                'استخدم زبدة أوروبية (أقل ماء = أقل انتشار)',
                                'تحقق من نوع الزبدة المستخدم'
                            ]
                        },
                        realTimeFix: {
                            title: '🚨 الإنقاذ الفوري:',
                            ifNotBaked: 'ضع الصينية في الفريزر 20 دقيقة',
                            ifBaking: 'خفّض الحرارة 10°م، أكمل الخبز',
                            ifDone: 'استخدمه كقاعدة تارت'
                        }
                    },
                    {
                        problem: 'قاسٍ وليس هشاً (يشبه البسكويت العادي)',
                        severity: 'متوسطة',
                        diagnosis: {
                            cause: 'تطور الغلوتين - الخلط الزائد أو نوع الزبدة غير المناسب',
                            scientific: 'الخلط الزائد يؤدي إلى تكوين شبكة غلوتين قوية - الزبدة النباتية قد تسبب ذلك',
                            howToKnow: 'صعب الكسر، يحتاج قوة، ينثني قليلاً قبل الكسر'
                        },
                        prevention: {
                            title: '🛡️ الوقاية:',
                            steps: [
                                'اخلط فقط حتى يختفي الدقيق',
                                'استخدم الطريقة المناسبة للقوام المطلوب',
                                'لا تعجن أو تضغط كثيراً',
                                'اختر نوع الزبدة المناسب للقوام المطلوب'
                            ]
                        },
                        realTimeFix: {
                            title: '🚨 الإنقاذ:',
                            ifNotBaked: 'لا يمكن الإصلاح - الغلوتين تكوّن بالفعل',
                            ifBaking: 'لا شيء يمكن فعله',
                            ifDone: 'اغمسه في الشاي/قهوة - يصبح ألذ'
                        }
                    },
                    {
                        problem: 'جاف جداً ومتفتت',
                        severity: 'متوسطة',
                        diagnosis: {
                            cause: 'نسبة الزبدة قليلة أو نوع الزبدة غير مناسب',
                            scientific: 'نقص الدهون يؤدي إلى جفاف العجين - الزبدة النباتية قد تسبب الجفاف',
                            howToKnow: 'يتفتت عند التقاطه، جاف الملمس'
                        },
                        prevention: {
                            title: '🛡️ الوقاية:',
                            steps: [
                                'تأكد من نسبة الزبدة الصحيحة',
                                'استخدم زبدة عالية الدسم',
                                'أضف القليل من السائل إذا لزم الأمر',
                                'اختبر العجين قبل الخبز'
                            ]
                        },
                        realTimeFix: {
                            title: '🚨 الإنقاذ:',
                            ifNotBaked: 'أضف القليل من الزبدة المذابة',
                            ifBaking: 'رش القليل من الماء على السطح',
                            ifDone: 'قدمه مع الصلصة أو الكريم'
                        }
                    }
                ];
                
                container.innerHTML = issues.map((issue, index) => `
                    <div class="issue-card" style="border: 2px solid #f87171; border-radius: 12px; background: #fef2f2; margin-bottom: 1rem; overflow: hidden;">
                        <div class="issue-header" style="width: 100%; padding: 1.5rem; display: flex; align-items: center; justify-content: space-between; background: #fef2f2; border: none; cursor: pointer;">
                            <div class="issue-main" style="display: flex; align-items: center; gap: 1rem; text-align: right;">
                                <div class="issue-icon" style="font-size: 3rem;">❌</div>
                                <div>
                                    <h3 class="issue-title" style="font-size: 1.25rem; font-weight: bold; color: #dc2626; margin: 0;">${issue.problem}</h3>
                                    <div class="issue-severity" style="display: inline-block; background: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; margin-top: 0.5rem;">
                                        خطورة ${issue.severity}
                                    </div>
                                </div>
                            </div>
                            <div class="issue-arrow" style="font-size: 1.5rem; transition: transform 0.3s;">▼</div>
                        </div>
                        <div class="issue-content" style="display: none; padding: 0 1.5rem 1.5rem;">
                            <div class="diagnosis-section" style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="color: #dc2626; margin-bottom: 1rem;">🔍 التشخيص العلمي المحسن</h4>
                                <div class="grid-3">
                                    <div class="diagnosis-item" style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                                        <div class="diagnosis-label" style="font-weight: bold; color: #d97706;">السبب المحتمل</div>
                                        <div class="diagnosis-value" style="color: #92400e;">${issue.diagnosis.cause}</div>
                                    </div>
                                    <div class="diagnosis-item" style="background: #dbeafe; padding: 1rem; border-radius: 8px;">
                                        <div class="diagnosis-label" style="font-weight: bold; color: #1e40af;">السبب العلمي</div>
                                        <div class="diagnosis-value" style="color: #1e3a8a;">${issue.diagnosis.scientific}</div>
                                    </div>
                                    <div class="diagnosis-item" style="background: #dcfce7; padding: 1rem; border-radius: 8px;">
                                        <div class="diagnosis-label" style="font-weight: bold; color: #059669;">كيف تعرف</div>
                                        <div class="diagnosis-value" style="color: #065f46;">${issue.diagnosis.howToKnow}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="prevention-section" style="background: #ecfdf5; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="color: #059669; margin-bottom: 1rem;">${issue.prevention.title}</h4>
                                <ul style="list-style-type: none; padding: 0; margin: 0;">
                                    ${issue.prevention.steps.map(step => `
                                        <li style="margin-bottom: 0.5rem; padding-right: 1.5rem; position: relative;">
                                            <span style="position: absolute; right: 0; top: 0;">✅</span>
                                            ${step}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            <div class="fix-section" style="background: #fef3c7; padding: 1.5rem; border-radius: 8px;">
                                <h4 style="color: #d97706; margin-bottom: 1rem;">${issue.realTimeFix.title}</h4>
                                <div class="grid-3">
                                    <div class="fix-item" style="background: white; padding: 1rem; border-radius: 8px;">
                                        <div class="fix-label" style="font-weight: bold; color: #d97706;">إذا لم يُخبز بعد</div>
                                        <div class="fix-value" style="color: #92400e;">${issue.realTimeFix.ifNotBaked}</div>
                                    </div>
                                    <div class="fix-item" style="background: white; padding: 1rem; border-radius: 8px;">
                                        <div class="fix-label" style="font-weight: bold; color: #d97706;">إذا كان يخبز الآن</div>
                                        <div class="fix-value" style="color: #92400e;">${issue.realTimeFix.ifBaking}</div>
                                    </div>
                                    <div class="fix-item" style="background: white; padding: 1rem; border-radius: 8px;">
                                        <div class="fix-label" style="font-weight: bold; color: #d97706;">إذا انتهى الخبز</div>
                                        <div class="fix-value" style="color: #92400e;">${issue.realTimeFix.ifDone}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // إضافة أحداث النقر للبطاقات
                document.querySelectorAll('.issue-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const arrow = this.querySelector('.issue-arrow');
                        
                        if (content.style.display === 'none') {
                            content.style.display = 'block';
                            arrow.style.transform = 'rotate(180deg)';
                        } else {
                            content.style.display = 'none';
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    });
                });
            }
            
            addTooltips() {
                const tooltips = [
                    {
                        selector: '#use-rice-flour',
                        text: 'دقيق الأرز يزيد القرمشة بنسبة 30% - موصى به للقوام المقرمش فقط'
                    },
                    {
                        selector: '#use-cornstarch',
                        text: 'نشا الذرة يحسن الطراوة - موصى به للقوام الطري فقط'
                    },
                    {
                        selector: '#pan-height',
                        text: 'النطاق المثالي: 1.0-2.0 سم - يؤثر على وقت الخبز والقوام'
                    }
                ];
                
                tooltips.forEach(tooltip => {
                    const element = document.querySelector(tooltip.selector);
                    if (element) {
                        element.setAttribute('title', tooltip.text);
                    }
                });
            }
            
            showNotification(message, type = 'info') {
                // إزالة أي إشعارات سابقة
                document.querySelectorAll('.notification').forEach(n => n.remove());
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.25rem;">${type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '✅'}</span>
                        <span>${message}</span>
                    </div>
                `;
                
                notification.style.background = type === 'error' ? '#dc2626' : 
                                              type === 'warning' ? '#d97706' : '#059669';
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
            
            showLoading() {
                // يمكن إضافة مؤشر تحميل هنا إذا لزم
            }
            
            hideLoading() {
                // إخفاء مؤشر التحميل
            }
            
            handleStateChange(key, value) {
                switch(key) {
                    case 'mode':
                        this.updateModeDisplay();
                        break;
                    case 'textureType':
                        this.validateAndWarn();
                        break;
                    case 'butterType':
                        this.validateAndWarn();
                        break;
                    case 'mixingMethod':
                        this.validateAndWarn();
                        break;
                }
            }
        }

        // =============================================
        // دوال محلل الوصفات اليدوي - المصححة
        // =============================================

        let currentMixingMethod = null;
        let currentButterType = null;
        let currentSugarType = null;

        function toggleInput(ingredient) {
            const checkbox = document.getElementById(`has-${ingredient}`);
            const input = document.getElementById(ingredient);
            
            if (checkbox.checked) {
                input.disabled = false;
                input.focus();
            } else {
                input.disabled = true;
                input.value = '';
            }
        }

        function selectAnalyzerMixingMethod(method, element) {
            currentMixingMethod = method;
            
            // إزالة التحديد من جميع أزرار طريقة الخلط
            document.querySelectorAll('#analyzer-screen .option-card').forEach(card => {
                const parentCard = card.closest('.card');
                if (parentCard && parentCard.querySelector('.subsection-title').textContent.includes('طريقة الخلط')) {
                    card.classList.remove('selected');
                }
            });
            
            element.classList.add('selected');
        }

        function selectAnalyzerButterType(type, element) {
            currentButterType = type;
            
            // إزالة التحديد من جميع أزرار نوع الزبدة
            document.querySelectorAll('#analyzer-screen .option-card').forEach(card => {
                const parentCard = card.closest('.card');
                if (parentCard && parentCard.querySelector('.subsection-title').textContent.includes('نوع الزبدة')) {
                    card.classList.remove('selected');
                }
            });
            
            element.classList.add('selected');
        }

        function selectAnalyzerSugarType(type, element) {
            currentSugarType = type;
            
            // إزالة التحديد من جميع أزرار نوع السكر
            document.querySelectorAll('#analyzer-screen .option-card').forEach(card => {
                const parentCard = card.closest('.card');
                if (parentCard && parentCard.querySelector('.subsection-title').textContent.includes('نوع السكر')) {
                    card.classList.remove('selected');
                }
            });
            
            element.classList.add('selected');
        }

        function analyzeManualRecipe() {
            // جمع البيانات من الحقول
            const ingredients = {
                flour: document.getElementById('flour').value ? parseInt(document.getElementById('flour').value) : null,
                butter: document.getElementById('butter').value ? parseInt(document.getElementById('butter').value) : null,
                sugar: document.getElementById('sugar').value ? parseInt(document.getElementById('sugar').value) : null,
                riceFlour: document.getElementById('rice-flour').value ? parseInt(document.getElementById('rice-flour').value) : null,
                cornstarch: document.getElementById('cornstarch').value ? parseInt(document.getElementById('cornstarch').value) : null,
                salt: document.getElementById('salt').value ? parseFloat(document.getElementById('salt').value) : null
            };
            
            const baking = {
                temperature: document.getElementById('baking-temp').value ? parseInt(document.getElementById('baking-temp').value) : null,
                time: document.getElementById('baking-time').value ? parseInt(document.getElementById('baking-time').value) : null
            };
            
            const techniques = {
                chilling: document.getElementById('has-chilling').checked,
                docking: document.getElementById('has-docking').checked,
                twiceBaked: document.getElementById('has-twice-baked').checked,
                vanilla: document.getElementById('has-vanilla').checked
            };
            
            // التحقق من المدخلات الأساسية
            if (!ingredients.flour || !ingredients.butter) {
                uiManager.showNotification('⚠️ يرجى إدخال كميات الدقيق والزبدة على الأقل', 'error');
                return;
            }
            
            if (!currentMixingMethod) {
                uiManager.showNotification('⚠️ يرجى تحديد طريقة الخلط المستخدمة', 'error');
                return;
            }
            
            // إجراء التحليل
            const analysis = analyzeRecipeData(ingredients, baking, techniques, currentMixingMethod, currentButterType, currentSugarType);
            displayManualAnalysisResults(analysis);
        }

        function analyzeRecipeData(ingredients, baking, techniques, mixingMethod, butterType, sugarType) {
            const analysis = {
                score: 0,
                strengths: [],
                weaknesses: [],
                recommendations: [],
                scientificAnalysis: [],
                ratios: {},
                texturePrediction: '',
                stability: '',
                waterActivity: '',
                profileMatch: '',
                detailedRatios: {},
                idealRanges: {}
            };
            
            // حساب النسب الأساسية
            const totalFlour = ingredients.flour + (ingredients.riceFlour || 0) + (ingredients.cornstarch || 0);
            
            analysis.ratios = {
                butterToFlour: ingredients.butter / totalFlour,
                sugarToFlour: ingredients.sugar ? ingredients.sugar / totalFlour : null,
                riceFlourRatio: ingredients.riceFlour ? ingredients.riceFlour / totalFlour : 0,
                cornstarchRatio: ingredients.cornstarch ? ingredients.cornstarch / totalFlour : 0,
                saltRatio: ingredients.salt ? ingredients.salt / totalFlour : 0
            };
        
            // النسب المثالية لكل نوع قوام
            analysis.idealRanges = {
                tender: {
                    butterToFlour: { min: 0.75, max: 0.95, ideal: 0.85 },
                    sugarToFlour: { min: 0.25, max: 0.40, ideal: 0.32 },
                    saltRatio: { min: 0.008, max: 0.012, ideal: 0.01 }
                },
                traditional: {
                    butterToFlour: { min: 0.60, max: 0.80, ideal: 0.70 },
                    sugarToFlour: { min: 0.30, max: 0.50, ideal: 0.40 },
                    saltRatio: { min: 0.008, max: 0.015, ideal: 0.012 }
                },
                crispy: {
                    butterToFlour: { min: 0.50, max: 0.70, ideal: 0.60 },
                    sugarToFlour: { min: 0.35, max: 0.55, ideal: 0.45 },
                    saltRatio: { min: 0.010, max: 0.018, ideal: 0.015 }
                }
            };
        
            // تحديد البروفايل المناسب بناء على المكونات والتقنيات
            const detectedProfile = detectProfileFromIngredients(analysis.ratios, mixingMethod, sugarType, baking.temperature);
            const ideal = analysis.idealRanges[detectedProfile.type];
            
            analysis.detectedProfile = detectedProfile;
            analysis.detectedProfileType = detectedProfile.type;
        
            // تحليل نسبة الزبدة إلى الدقيق بدقة
            const butterRatio = analysis.ratios.butterToFlour;
            const butterDeviation = Math.abs(butterRatio - ideal.butterToFlour.ideal) / ideal.butterToFlour.ideal;
            
            if (butterDeviation <= 0.1) {
                analysis.score += 30;
                analysis.strengths.push(`نسبة الزبدة ممتازة (${(butterRatio * 100).toFixed(1)}%) - مثالية للقوام ${detectedProfile.name}`);
            } else if (butterDeviation <= 0.2) {
                analysis.score += 20;
                analysis.strengths.push(`نسبة الزبدة جيدة (${(butterRatio * 100).toFixed(1)}%) - مناسبة للقوام ${detectedProfile.name}`);
            } else {
                if (butterRatio < ideal.butterToFlour.min) {
                    analysis.score += 10;
                    const neededButter = Math.round((ideal.butterToFlour.ideal - butterRatio) * totalFlour);
                    analysis.weaknesses.push(`نسبة الزبدة منخفضة (${(butterRatio * 100).toFixed(1)}%) - تحتاج +${neededButter}جرام زبدة`);
                    analysis.recommendations.push(`أضف ${neededButter} جرام زبدة للوصول إلى النسبة المثالية (${(ideal.butterToFlour.ideal * 100).toFixed(1)}%)`);
                } else {
                    analysis.score += 15;
                    const excessButter = Math.round((butterRatio - ideal.butterToFlour.ideal) * totalFlour);
                    analysis.weaknesses.push(`نسبة الزبدة مرتفعة (${(butterRatio * 100).toFixed(1)}%) - يمكن تقليل ${excessButter}جرام`);
                    analysis.recommendations.push(`قلل ${excessButter} جرام زبدة للوصول إلى النسبة المثالية (${(ideal.butterToFlour.ideal * 100).toFixed(1)}%)`);
                }
            }
        
            // تحليل نسبة السكر بدقة
            if (analysis.ratios.sugarToFlour) {
                const sugarRatio = analysis.ratios.sugarToFlour;
                const sugarDeviation = Math.abs(sugarRatio - ideal.sugarToFlour.ideal) / ideal.sugarToFlour.ideal;
                
                if (sugarDeviation <= 0.15) {
                    analysis.score += 20;
                    analysis.strengths.push(`نسبة السكر متوازنة (${(sugarRatio * 100).toFixed(1)}%) - ${sugarType === 'powdered' ? 'بودرة' : 'محبب'}`);
                } else {
                    if (sugarRatio < ideal.sugarToFlour.min) {
                        analysis.score += 10;
                        const neededSugar = Math.round((ideal.sugarToFlour.ideal - sugarRatio) * totalFlour);
                        analysis.weaknesses.push(`نسبة السكر منخفضة (${(sugarRatio * 100).toFixed(1)}%) - تحتاج +${neededSugar}جرام سكر`);
                        analysis.recommendations.push(`أضف ${neededSugar} جرام سكر ${sugarType === 'powdered' ? 'بودرة' : 'محبب'} للتحلية المتوازنة`);
                    } else {
                        analysis.score += 15;
                        const excessSugar = Math.round((sugarRatio - ideal.sugarToFlour.ideal) * totalFlour);
                        analysis.weaknesses.push(`نسبة السكر مرتفعة (${(sugarRatio * 100).toFixed(1)}%) - يمكن تقليل ${excessSugar}جرام`);
                        analysis.recommendations.push(`قلل ${excessSugar} جرام سكر لتجنب الحلاوة المفرطة`);
                    }
                }
        
                // تحليل نوع السكر vs القوام
                if (sugarType === 'powdered' && detectedProfile.type === 'tender') {
                    analysis.score += 5;
                    analysis.strengths.push('السكر البودرة مثالي للقوام الطري الذي يذوب في الفم');
                } else if (sugarType === 'granulated' && detectedProfile.type === 'crispy') {
                    analysis.score += 5;
                    analysis.strengths.push('السكر المحبب يعزز القرمشة والقوام المتقشر');
                }
            }
        
            // تحليل الملح بدقة
            if (analysis.ratios.saltRatio) {
                const saltRatio = analysis.ratios.saltRatio;
                if (saltRatio >= ideal.saltRatio.min && saltRatio <= ideal.saltRatio.max) {
                    analysis.score += 10;
                    analysis.strengths.push(`نسبة الملح متوازنة (${(saltRatio * 100).toFixed(2)}%)`);
                } else {
                    if (saltRatio < ideal.saltRatio.min) {
                        analysis.score += 5;
                        const neededSalt = Math.round((ideal.saltRatio.ideal - saltRatio) * totalFlour * 1000) / 1000;
                        analysis.weaknesses.push(`نسبة الملح منخفضة (${(saltRatio * 100).toFixed(2)}%) - تحتاج +${(neededSalt * 1000).toFixed(1)}ملجرام`);
                        analysis.recommendations.push(`أضف ${(neededSalt * 1000).toFixed(1)} ملجرام ملح لتعزيز النكهة`);
                    } else {
                        analysis.score += 5;
                        const excessSalt = Math.round((saltRatio - ideal.saltRatio.ideal) * totalFlour * 1000) / 1000;
                        analysis.weaknesses.push(`نسبة الملح مرتفعة (${(saltRatio * 100).toFixed(2)}%) - يمكن تقليل ${(excessSalt * 1000).toFixed(1)}ملجرام`);
                        analysis.recommendations.push(`قلل ${(excessSalt * 1000).toFixed(1)} ملجرام ملح لتجنب الملوحة الزائدة`);
                    }
                }
            }
        
            // تحليل طريقة الخلط
            analysis.score += 20;
            if (mixingMethod === 'creaming' && detectedProfile.type === 'tender') {
                analysis.strengths.push('✅ طريقة الخفق (Creaming) مثالية للقوام الطري');
                analysis.texturePrediction = 'قوام طري يذوب في الفم مع نعومة استثنائية';
            } else if (mixingMethod === 'sablage' && detectedProfile.type === 'crispy') {
                analysis.strengths.push('✅ طريقة الفرك (Sablage) مثالية للقوام المقرمش');
                analysis.texturePrediction = 'قوام مقرمش متقشر مع طبقات واضحة';
            } else if (mixingMethod === 'sablage' && detectedProfile.type === 'tender') {
                analysis.weaknesses.push('⚠️ طريقة الفرك قد تنتج قواماً أقل طراوة من المتوقع');
                analysis.recommendations.push('جرب طريقة الخفق (Creaming) للحصول على قوام أطرى');
            } else {
                analysis.strengths.push(`طريقة ${mixingMethod === 'sablage' ? 'الفرك' : 'الخفق'} مناسبة للقوام ${detectedProfile.name}`);
            }
            
            // حساب نشاط الماء
            const waterActivity = calculateWaterActivity(ingredients, butterType, baking.temperature, techniques.twiceBaked);
            analysis.waterActivity = waterActivity;
            analysis.scientificAnalysis.push(`💧 نشاط الماء المتوقع (Aw): ${waterActivity}`);
            
            // تحديد الاستقرار بناءً على Aw
            if (waterActivity < 0.25) {
                analysis.stability = 'استثنائية (45-60 يوم)';
            } else if (waterActivity < 0.30) {
                analysis.stability = 'عالية جداً (30-45 يوم)';
            } else if (waterActivity < 0.35) {
                analysis.stability = 'عالية (21-30 يوم)';
            } else if (waterActivity < 0.40) {
                analysis.stability = 'عالية (14-21 يوم)';
            } else if (waterActivity < 0.45) {
                analysis.stability = 'متوسطة (7-14 يوم)';
            } else {
                analysis.stability = 'محدودة (3-7 أيام)';
            }
            
            // تحليل التقنيات الإضافية
            if (techniques.chilling) {
                analysis.score += 5;
                analysis.strengths.push('✅ التبريد قبل الخبز يحسن القوام ويمنع الانتشار');
            }
            
            if (techniques.docking) {
                analysis.score += 3;
                analysis.strengths.push('✅ التخريم (Docking) يمنع انتفاخ العجين');
            }
            
            if (techniques.twiceBaked && detectedProfile.type === 'crispy') {
                analysis.score += 8;
                analysis.strengths.push('✅ الخبز المزدوج مثالي للقرمشة الاستثنائية');
            } else if (techniques.twiceBaked && detectedProfile.type !== 'crispy') {
                analysis.weaknesses.push('⚠️ الخبز المزدوج قد يجعل القوام جافاً جداً');
                analysis.recommendations.push('استخدم الخبز المزدوج فقط للقوام المقرمش');
            }
        
            // التقييم النهائي
            analysis.finalGrade = getAnalysisGrade(analysis.score);
            
            // مقارنة مع البروفايلات القياسية
            analysis.profileMatches = compareWithProfiles(analysis, ingredients, mixingMethod);
        
            // اقتراحات ذكية للتحسين
            analysis.smartSuggestions = generateSmartSuggestions(analysis, ingredients);
        
            return analysis;
        }

        function calculateWaterActivity(ingredients, butterType, bakingTemp, twiceBaked) {
            const recipeEngine = new RecipeEngine();
            
            const totalFlour = ingredients.flour + (ingredients.riceFlour || 0) + (ingredients.cornstarch || 0);
            const butter = ingredients.butter;
            const sugar = ingredients.sugar || Math.round(totalFlour * 0.4);
            
            try {
                const awAnalysis = recipeEngine.calculateWaterActivity(
                    { 
                        flour: totalFlour, 
                        butter: butter, 
                        sugar: sugar 
                    },
                    butterType || 'european',
                    bakingTemp || 177,
                    twiceBaked || false
                );
                
                return awAnalysis.value;
            } catch (error) {
                console.error('Error in water activity calculation:', error);
                return calculateWaterActivityFallback(ingredients, butterType, bakingTemp, twiceBaked);
            }
        }
        
        function calculateWaterActivityFallback(ingredients, butterType, bakingTemp, twiceBaked) {
            let baseAw = 0.45;
            
            // تأثير نسبة الزبدة
            if (ingredients.butter && ingredients.flour) {
                const butterRatio = ingredients.butter / ingredients.flour;
                if (butterRatio > 0.7) baseAw -= 0.05;
                if (butterRatio < 0.5) baseAw += 0.05;
            }
            
            // تأثير المضافات
            if (ingredients.riceFlour) baseAw -= 0.03;
            if (ingredients.cornstarch) baseAw += 0.02;
            
            // تأثير درجة حرارة الخبز
            if (bakingTemp) {
                if (bakingTemp > 170) baseAw -= 0.04;
                if (bakingTemp < 150) baseAw += 0.04;
            }
            
            // تأثير نوع الزبدة
            if (butterType === 'vegetable') baseAw -= 0.06;
            if (butterType === 'american') baseAw += 0.02;
            
            // تأثير الخبز المزدوج
            if (twiceBaked) baseAw -= 0.08;
            
            return Math.max(0.20, Math.min(0.70, baseAw)).toFixed(3);
        }
        
        function detectProfileFromIngredients(ratios, mixingMethod, sugarType, bakingTemp) {
            let scores = {
                tender: 0,
                traditional: 0,
                crispy: 0
            };
        
            // تحليل نسبة الزبدة
            if (ratios.butterToFlour >= 0.75) scores.tender += 3;
            else if (ratios.butterToFlour >= 0.60) scores.traditional += 2;
            else scores.crispy += 2;
        
            // تحليل نوع السكر
            if (sugarType === 'powdered') scores.tender += 2;
            else if (sugarType === 'granulated') scores.crispy += 1;
        
            // تحليل طريقة الخلط
            if (mixingMethod === 'creaming') scores.tender += 2;
            else if (mixingMethod === 'sablage') scores.crispy += 2;
        
            // تحليل درجة حرارة الخبز
            if (bakingTemp && bakingTemp < 155) scores.tender += 1;
            else if (bakingTemp && bakingTemp > 170) scores.crispy += 1;
        
            // إيجاد البروفايل الفائز
            let maxScore = Math.max(scores.tender, scores.traditional, scores.crispy);
            let detectedProfile = 'traditional';
            
            if (scores.tender === maxScore) detectedProfile = 'tender';
            else if (scores.crispy === maxScore) detectedProfile = 'crispy';
        
            const profileNames = {
                tender: { name: 'طري يذوب في الفم', type: 'tender' },
                traditional: { name: 'متوازن تقليدي', type: 'traditional' },
                crispy: { name: 'مقرمش متقشر', type: 'crispy' }
            };
        
            return profileNames[detectedProfile];
        }
        
        function compareWithProfiles(analysis, ingredients, mixingMethod) {
            const profiles = ScientificData.PROFILES;
            const matches = [];
            
            Object.keys(profiles).forEach(profileKey => {
                const profile = profiles[profileKey];
                let matchScore = 0;
                const maxScore = 100;
                
                // مقارنة نسبة الزبدة (30 نقطة)
                const profileButterRatio = profile.ratio[1] / profile.ratio[2];
                const actualButterRatio = analysis.ratios.butterToFlour;
                const butterDiff = Math.abs(profileButterRatio - actualButterRatio);
                matchScore += Math.max(0, 30 - (butterDiff * 50));
                
                // مقارنة طريقة الخلط (25 نقطة)
                if (profile.mixingMethod === mixingMethod) {
                    matchScore += 25;
                }
                
                // مقارنة المضافات (25 نقطة)
                if (profile.additive.type !== 'none') {
                    if (profile.additive.type === 'riceFlour' && ingredients.riceFlour) {
                        const additiveMatch = 1 - Math.abs(profile.additive.ratio - analysis.ratios.riceFlourRatio);
                        matchScore += additiveMatch * 25;
                    } else if (profile.additive.type === 'cornstarch' && ingredients.cornstarch) {
                        const additiveMatch = 1 - Math.abs(profile.additive.ratio - analysis.ratios.cornstarchRatio);
                        matchScore += additiveMatch * 25;
                    }
                } else {
                    // إذا لم يستخدم المضافات والبروفايل لا يحتاجها
                    if (!ingredients.riceFlour && !ingredients.cornstarch) {
                        matchScore += 25;
                    }
                }
                
                // مقارنة نوع السكر (20 نقطة)
                if (profile.sugarType === 'powdered' && currentSugarType === 'powdered') {
                    matchScore += 20;
                } else if (profile.sugarType === 'granulated' && currentSugarType === 'granulated') {
                    matchScore += 20;
                }
                
                if (matchScore > 50) {
                    matches.push({
                        profile: profileKey,
                        score: Math.min(100, matchScore),
                        name: profile.name,
                        description: profile.description
                    });
                }
            });
            
            // ترتيب حسب التطابق
            matches.sort((a, b) => b.score - a.score);
            
            return matches;
        }
        
        function generateSmartSuggestions(analysis, ingredients) {
            const suggestions = [];
            
            // تحليل نسبة الزبدة
            if (analysis.ratios.butterToFlour < 0.6) {
                suggestions.push({
                    type: 'critical',
                    icon: '🧈',
                    title: 'نقص في الزبدة',
                    message: `نسبة الزبدة ${(analysis.ratios.butterToFlour * 100).toFixed(1)}% منخفضة`,
                    suggestion: `أضف ${Math.round((0.65 - analysis.ratios.butterToFlour) * ingredients.flour)} جرام زبدة إضافية`,
                    impact: '+15 نقطة متوقعة',
                    priority: 1
                });
            } else if (analysis.ratios.butterToFlour > 0.8) {
                suggestions.push({
                    type: 'medium',
                    icon: '🧈',
                    title: 'زيادة في الزبدة',
                    message: `نسبة الزبدة ${(analysis.ratios.butterToFlour * 100).toFixed(1)}% مرتفعة`,
                    suggestion: `قلل بمقدار ${Math.round((analysis.ratios.butterToFlour - 0.7) * ingredients.flour)} جرام زبدة`,
                    impact: '+10 نقاط محتملة',
                    priority: 2
                });
            }
            
            // تحليل طريقة الخلط vs القوام المتوقع
            if (analysis.texturePrediction.includes('طري') && currentMixingMethod === 'sablage') {
                suggestions.push({
                    type: 'medium',
                    icon: '🌀',
                    title: 'تناقض في طريقة الخلط',
                    message: 'طريقة الفرك (Sablage) تستخدم عادة للقوام المقرمش',
                    suggestion: 'جرب طريقة الخفق (Creaming) للحصول على قوام أطرى',
                    impact: '+10 نقاط محتملة',
                    priority: 2
                });
            }
            
            if (analysis.texturePrediction.includes('مقرمش') && currentMixingMethod === 'creaming') {
                suggestions.push({
                    type: 'medium',
                    icon: '🌀',
                    title: 'تناقض في طريقة الخلط',
                    message: 'طريقة الخفق (Creaming) تستخدم عادة للقوام الطري',
                    suggestion: 'جرب طريقة الفرك (Sablage) للحصول على قرمشة أفضل',
                    impact: '+10 نقاط محتملة',
                    priority: 2
                });
            }
            
            // اقتراح الخبز المزدوج للقرمشة
            if (analysis.texturePrediction.includes('مقرمش') && !analysis.strengths.some(s => s.includes('الخبز المزدوج'))) {
                suggestions.push({
                    type: 'high',
                    icon: '🔥',
                    title: 'تقنية الخبز المزدوج',
                    message: 'مثالية للقوام المقرمش',
                    suggestion: 'طبق تقنية الخبز المزدوج: اخبز 35 دقيقة، اقطع، ثم اخبز 30 دقيقة في فرن مطفأ',
                    impact: '+8 نقاط + عمر تخزيني أطول',
                    priority: 1
                });
            }
            
            // اقتراح التبريد إذا لم يُستخدم
            if (!analysis.strengths.some(s => s.includes('التبريد'))) {
                suggestions.push({
                    type: 'medium',
                    icon: '❄️',
                    title: 'التبريد قبل الخبز',
                    message: 'مهم لمنع الانتشار المفرط',
                    suggestion: 'برد العجين لمدة ساعة على الأقل قبل الخبز',
                    impact: '+5 نقاط',
                    priority: 2
                });
            }
            
            // ترتيب حسب الأولوية
            return suggestions.sort((a, b) => a.priority - b.priority);
        }

        function getAnalysisGrade(score) {
            if (score >= 90) return { grade: 'ممتاز', color: '#059669', icon: '🏆' };
            if (score >= 80) return { grade: 'جيد جداً', color: '#10b981', icon: '⭐' };
            if (score >= 70) return { grade: 'جيد', color: '#d97706', icon: '👍' };
            if (score >= 60) return { grade: 'مقبول', color: '#ea580c', icon: '📊' };
            return { grade: 'يحتاج تحسين', color: '#dc2626', icon: '🔧' };
        }

        function displayManualAnalysisResults(analysis) {
            const container = document.getElementById('manual-analysis-results');
            
            let html = `
                <div class="card card-purple">
                    <h3 class="subsection-title">📊 نتائج التحليل العلمي</h3>
                    
                    <!-- التقييم العام -->
                    <div style="text-align: center; padding: 2rem; background: ${analysis.finalGrade.color}15; border-radius: 12px; border: 2px solid ${analysis.finalGrade.color}; margin-bottom: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${analysis.finalGrade.icon}</div>
                        <div style="font-size: 2rem; font-weight: bold; color: ${analysis.finalGrade.color}; margin-bottom: 0.5rem;">
                            ${analysis.finalGrade.grade}
                        </div>
                        <div style="font-size: 1.5rem; color: ${analysis.finalGrade.color};">
                            ${analysis.score}/100
                        </div>
                    </div>
        
                    <!-- توقع القوام والاستقرار -->
                    <div class="grid-3">
                        <div class="card">
                            <h4 class="subsection-title">🎯 توقع القوام</h4>
                            <div style="font-size: 1.1rem; color: var(--primary-color); font-weight: bold; line-height: 1.4;">
                                ${analysis.texturePrediction}
                            </div>
                        </div>
                        <div class="card">
                            <h4 class="subsection-title">🛡️ الاستقرار المتوقع</h4>
                            <div style="font-size: 1.1rem; color: var(--secondary-color); font-weight: bold;">
                                ${analysis.stability}
                            </div>
                        </div>
                        <div class="card">
                            <h4 class="subsection-title">📈 البروفايل المتطابق</h4>
                            <div style="font-size: 1.1rem; color: var(--primary-dark); font-weight: bold;">
                                ${analysis.profileMatch || 'مختلط'}
                            </div>
                        </div>
                    </div>
            `;
        
            // 📊 التحليل التفصيلي للنسب
            if (analysis.detectedProfile && analysis.idealRanges) {
                html += `
                    <div class="card card-blue">
                        <h4 class="subsection-title">📈 التحليل التفصيلي للنسب</h4>
                        <div class="grid-3">
                            <div class="stat-card">
                                <div class="stat-label">الزبدة إلى الدقيق</div>
                                <div class="stat-value">${(analysis.ratios.butterToFlour * 100).toFixed(1)}%</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    المثالي: ${(analysis.idealRanges[analysis.detectedProfileType].butterToFlour.ideal * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">السكر إلى الدقيق</div>
                                <div class="stat-value">${analysis.ratios.sugarToFlour ? (analysis.ratios.sugarToFlour * 100).toFixed(1) + '%' : 'غير محدد'}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${analysis.ratios.sugarToFlour ? `المثالي: ${(analysis.idealRanges[analysis.detectedProfileType].sugarToFlour.ideal * 100).toFixed(1)}%` : ''}
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">الملح إلى الدقيق</div>
                                <div class="stat-value">${analysis.ratios.saltRatio ? (analysis.ratios.saltRatio * 100).toFixed(2) + '%' : 'غير محدد'}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${analysis.ratios.saltRatio ? `المثالي: ${(analysis.idealRanges[analysis.detectedProfileType].saltRatio.ideal * 100).toFixed(2)}%` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="font-semibold text-amber-900">🎯 البروفايل المكتشف: ${analysis.detectedProfile.name}</div>
                            <div class="text-sm text-amber-700 mt-1">
                                النظام اكتشف أن وصفتك تتوافق مع بروفايل ${analysis.detectedProfile.name} بناءً على نسب المكونات والتقنيات المستخدمة.
                            </div>
                        </div>
                    </div>
                `;
            }
        
            // النقاط القوية
            if (analysis.strengths.length > 0) {
                html += `
                    <div class="card card-green">
                        <h4 class="subsection-title">✅ النقاط القوية</h4>
                        <ul class="space-y-2">
                            ${analysis.strengths.map(strength => `<li>✅ ${strength}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // نقاط التحسين
            if (analysis.weaknesses.length > 0) {
                html += `
                    <div class="card card-red">
                        <h4 class="subsection-title">⚠️ نقاط تحتاج تحسين</h4>
                        <ul class="space-y-2">
                            ${analysis.weaknesses.map(weakness => `<li>⚠️ ${weakness}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // التوصيات
            if (analysis.recommendations.length > 0) {
                html += `
                    <div class="card card-blue">
                        <h4 class="subsection-title">💡 التوصيات العلمية</h4>
                        <ul class="space-y-2">
                            ${analysis.recommendations.map(rec => `<li>💡 ${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        
            // ✅ عرض الاقتراحات الذكية
            if (analysis.smartSuggestions && analysis.smartSuggestions.length > 0) {
                html += `
                    <div class="card card-blue">
                        <h4 class="subsection-title">💡 اقتراحات ذكية للتحسين</h4>
                        ${analysis.smartSuggestions.map(suggestion => `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: ${getSuggestionColor(suggestion.type)}; border-radius: 8px; border-right: 4px solid ${getSuggestionBorderColor(suggestion.type)};">
                                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                    <div style="font-size: 1.5rem;">${suggestion.icon}</div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                            <div>
                                                <div style="font-weight: bold; color: ${getSuggestionTextColor(suggestion.type)};">${suggestion.title}</div>
                                                <div style="color: #666; font-size: 0.9rem;">${suggestion.message}</div>
                                            </div>
                                            <div style="background: ${getSuggestionImpactColor(suggestion.type)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
                                                ${suggestion.impact}
                                            </div>
                                        </div>
                                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #e5e7eb;">
                                            <span style="font-weight: 600;">الحل:</span> ${suggestion.suggestion}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        
            // التحليل العلمي
            html += `
                <div class="card card-amber">
                    <h4 class="subsection-title">🔬 التحليل العلمي المتقدم</h4>
                    <div class="grid-2">
                        ${analysis.scientificAnalysis.map(item => `
                            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.5rem;">
                                ${item}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        
            // عرض مقارنة البروفايلات
            if (analysis.profileMatches && analysis.profileMatches.length > 0) {
                html += `
                    <div class="card card-green">
                        <h4 class="subsection-title">🎯 التطابق مع البروفايلات القياسية</h4>
                        ${analysis.profileMatches.map(match => `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-right: 4px solid var(--primary-color);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold; font-size: 1.1rem;">${match.name}</span>
                                    <span style="color: var(--primary-color); font-weight: bold; font-size: 1.1rem;">${match.score.toFixed(0)}% تطابق</span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">${match.description}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        
            html += `</div>`;
            
            container.innerHTML = html;
            container.classList.remove('hidden');
            
            // التمرير إلى النتائج
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function getSuggestionColor(type) {
            const colors = {
                'critical': '#fee2e2',
                'high': '#fef3c7', 
                'medium': '#dbeafe',
                'low': '#ecfdf5'
            };
            return colors[type] || '#f3f4f6';
        }
        
        function getSuggestionBorderColor(type) {
            const colors = {
                'critical': '#dc2626',
                'high': '#d97706',
                'medium': '#3b82f6',
                'low': '#059669'
            };
            return colors[type] || '#6b7280';
        }
        
        function getSuggestionTextColor(type) {
            const colors = {
                'critical': '#dc2626',
                'high': '#d97706',
                'medium': '#1e40af',
                'low': '#059669'
            };
            return colors[type] || '#374151';
        }
        
        function getSuggestionImpactColor(type) {
            const colors = {
                'critical': '#dc2626',
                'high': '#d97706',
                'medium': '#3b82f6',
                'low': '#059669'
            };
            return colors[type] || '#6b7280';
        }

        function loadSampleRecipe(type) {
            const samples = {
                'ted-lasso': {
                    flour: 240,
                    butter: 227,
                    sugar: 90,
                    salt: 1,
                    bakingTemp: 149,
                    bakingTime: 50,
                    mixingMethod: 'creaming',
                    butterType: 'american',
                    sugarType: 'powdered',
                    techniques: {
                        chilling: true,
                        docking: true,
                        twiceBaked: false,
                        vanilla: true
                    }
                },
                'traditional': {
                    flour: 300,
                    butter: 200,
                    sugar: 100,
                    salt: 2,
                    bakingTemp: 160,
                    bakingTime: 25,
                    mixingMethod: 'sablage',
                    butterType: 'european',
                    sugarType: 'granulated',
                    techniques: {
                        chilling: true,
                        docking: true,
                        twiceBaked: false,
                        vanilla: false
                    }
                },
                'crispy': {
                    flour: 200,
                    butter: 180,
                    sugar: 80,
                    riceFlour: 50,
                    salt: 2,
                    bakingTemp: 177,
                    bakingTime: 35,
                    mixingMethod: 'sablage',
                    butterType: 'european',
                    sugarType: 'granulated',
                    techniques: {
                        chilling: true,
                        docking: true,
                        twiceBaked: true,
                        vanilla: false
                    }
                }
            };
            
            const sample = samples[type];
            
            // تعبئة الحقول الأساسية
            document.getElementById('has-flour').checked = true;
            document.getElementById('flour').value = sample.flour;
            document.getElementById('flour').disabled = false;
            
            document.getElementById('has-butter').checked = true;
            document.getElementById('butter').value = sample.butter;
            document.getElementById('butter').disabled = false;
            
            document.getElementById('has-sugar').checked = true;
            document.getElementById('sugar').value = sample.sugar;
            document.getElementById('sugar').disabled = false;
            
            document.getElementById('has-salt').checked = true;
            document.getElementById('salt').value = sample.salt;
            document.getElementById('salt').disabled = false;
            
            // تعبئة الحقول الاختيارية
            if (sample.riceFlour) {
                document.getElementById('has-rice-flour').checked = true;
                document.getElementById('rice-flour').value = sample.riceFlour;
                document.getElementById('rice-flour').disabled = false;
            } else {
                document.getElementById('has-rice-flour').checked = false;
                document.getElementById('rice-flour').value = '';
                document.getElementById('rice-flour').disabled = true;
            }
            
            // إعادة تعيين نشا الذرة
            document.getElementById('has-cornstarch').checked = false;
            document.getElementById('cornstarch').value = '';
            document.getElementById('cornstarch').disabled = true;
            
            // تعبئة إعدادات الخبز
            document.getElementById('baking-temp').value = sample.bakingTemp;
            document.getElementById('baking-time').value = sample.bakingTime;
            
            // تعبئة التقنيات
            document.getElementById('has-chilling').checked = sample.techniques.chilling;
            document.getElementById('has-docking').checked = sample.techniques.docking;
            document.getElementById('has-twice-baked').checked = sample.techniques.twiceBaked;
            document.getElementById('has-vanilla').checked = sample.techniques.vanilla;
            
            // تحديد الطرق باستخدام العناصر الصحيحة
            const mixingCards = document.querySelectorAll('.card:has(.subsection-title:contains("طريقة الخلط")) .option-card');
            const butterCards = document.querySelectorAll('.card:has(.subsection-title:contains("نوع الزبدة")) .option-card');
            const sugarCards = document.querySelectorAll('.card:has(.subsection-title:contains("نوع السكر")) .option-card');
            
            // تحديد طريقة الخلط
            if (sample.mixingMethod === 'sablage') {
                selectAnalyzerMixingMethod('sablage', mixingCards[0]);
            } else if (sample.mixingMethod === 'creaming') {
                selectAnalyzerMixingMethod('creaming', mixingCards[1]);
            } else {
                selectAnalyzerMixingMethod('unknown', mixingCards[2]);
            }
            
            // تحديد نوع الزبدة
            if (sample.butterType === 'european') {
                selectAnalyzerButterType('european', butterCards[0]);
            } else if (sample.butterType === 'american') {
                selectAnalyzerButterType('american', butterCards[1]);
            } else if (sample.butterType === 'vegetable') {
                selectAnalyzerButterType('vegetable', butterCards[2]);
            } else {
                selectAnalyzerButterType('unknown', butterCards[3]);
            }
            
            // تحديد نوع السكر
            if (sample.sugarType === 'granulated') {
                selectAnalyzerSugarType('granulated', sugarCards[0]);
            } else if (sample.sugarType === 'powdered') {
                selectAnalyzerSugarType('powdered', sugarCards[1]);
            } else {
                selectAnalyzerSugarType('unknown', sugarCards[2]);
            }
            
            uiManager.showNotification(`✅ تم تحميل وصفة ${type === 'ted-lasso' ? 'بسكويت تيد لاسو' : type === 'traditional' ? 'التقليدية المتوازنة' : 'المقرمشة'}`);
        }

        // =============================================
        // التهيئة والوظائف العامة
        // =============================================

        let uiManager = null;
        
        // دوال مساعدة للوصول من HTML
        function handleMixingMethodSelect(method, element) {
            if (uiManager) {
                uiManager.selectMixingMethod(method, { currentTarget: element });
            }
        }

        function switchTab(tabName) {
            if (uiManager) uiManager.switchTab(tabName);
        }

        function selectQuickProfile(profile) {
            if (uiManager) uiManager.selectQuickProfile(profile);
        }

        function selectTexture(texture) {
            if (uiManager) uiManager.selectTexture(texture);
        }

        function selectButter(butterType) {
            if (uiManager) uiManager.selectButter(butterType);
        }

        function setMode(mode) {
            if (uiManager) uiManager.setMode(mode);
        }

        function init() {
            if (uiManager) {
                console.warn('UIManager already initialized');
                return;
            }
            
            uiManager = new UIManager();
            
            // تعريف الدوال على النطاق العام للوصول من HTML
            window.uiManager = uiManager;
            window.switchTab = switchTab;
            window.selectQuickProfile = selectQuickProfile;
            window.selectTexture = selectTexture;
            window.selectButter = selectButter;
            window.selectMixingMethod = handleMixingMethodSelect;
            window.setMode = setMode;
            window.toggleInput = toggleInput;
            window.selectAnalyzerMixingMethod = selectAnalyzerMixingMethod;
            window.selectAnalyzerButterType = selectAnalyzerButterType;
            window.selectAnalyzerSugarType = selectAnalyzerSugarType;
            window.analyzeManualRecipe = analyzeManualRecipe;
            window.loadSampleRecipe = loadSampleRecipe;
            
            console.log('✅ تم تهيئة مهندس الشورت بريد العلمي المحسن بنجاح!');
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>